<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="ìš©ì¸ëŒ€í•™êµ êµì§ì› ì¶œì„ ì‹œìŠ¤í…œ - QRì½”ë“œì™€ GPSë¥¼ í†µí•œ ê°„í¸í•œ ì¶œì„ ì²´í¬">

  <title>ì¶œì„ ì²´í¬</title>


  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'pulse-slow': 'pulse 3s infinite',
            'bounce-slow': 'bounce 2s infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <!-- Leaflet.js for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- html5-qrcode for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- html2canvas for certificate capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ì»¤ìŠ¤í…€ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B8DD6 100%);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .dark .gradient-bg {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e3a5f 100%);
    }

    /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ì¹´ë“œ */
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .dark .glass-card {
      background: rgba(30, 41, 59, 0.95);
    }

    /* QR ìŠ¤ìºë„ˆ ìŠ¤íƒ€ì¼ */
    #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    #qr-reader video {
      border-radius: 12px;
    }

    /* í† ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    .toast-enter {
      animation: toastEnter 0.3s ease-out;
    }

    .toast-exit {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes toastEnter {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ íš¨ê³¼ */
    .input-focus-ring:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    /* ìŠ¤í”¼ë„ˆ */
    .spinner {
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* íƒ­ ì¸ë””ì¼€ì´í„° */
    .tab-indicator {
      transition: transform 0.3s ease, width 0.3s ease;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 640px) {
      .mobile-padding {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }

    /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* ìœ„ì¹˜ ì§€ë„ */
    #locationMap {
      height: 250px;
      width: 100%;
      border-radius: 12px;
      z-index: 0;
    }

    .location-map-card {
      transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease;
      overflow: hidden;
    }

    .location-map-card.collapsed {
      max-height: 0;
      opacity: 0;
      margin: 0;
    }

    .location-map-card.expanded {
      max-height: 600px;
      opacity: 1;
    }

    /* ì¶œì„ í™•ì¸ì¦ ì¹´ë“œ */
    .certificate-card {
      max-width: 400px;
      margin: 0 auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      background: white;
    }

    .certificate-header {
      background: linear-gradient(135deg, #10b981, #059669);
      padding: 24px 20px;
      text-align: center;
      color: white;
    }

    .certificate-body {
      padding: 20px;
    }

    .certificate-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .certificate-grid-item {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .certificate-grid-item .label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .certificate-grid-item .value {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .certificate-meeting {
      margin-top: 12px;
      padding: 10px;
      background: #eef2ff;
      border-radius: 8px;
      text-align: center;
    }

    .certificate-meeting .label {
      font-size: 11px;
      color: #6366f1;
      margin-bottom: 2px;
    }

    .certificate-meeting .value {
      font-size: 14px;
      font-weight: 600;
      color: #4338ca;
    }

    .certificate-footer {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #e5e7eb;
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
    }

    .certificate-confirm-number {
      margin: 12px 0 16px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-family: monospace;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
    }

    /* ë‚´ ì¶œì„ í™•ì¸ ì„¹ì…˜ */
    .attendance-check-toggle {
      cursor: pointer;
      user-select: none;
    }

    .attendance-check-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.3s ease;
    }

    .attendance-check-content.expanded {
      max-height: 800px;
    }

    .attendance-check-result {
      transition: all 0.3s ease;
    }

    /* ===== ë‹¨ê³„ë³„ í™”ë©´ UI ===== */
    .step-screen {
      display: none;
    }
    .step-screen.active {
      display: block;
      animation: stepIn 0.35s ease-out;
    }
    @keyframes stepIn {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* í° ë²„íŠ¼ */
    .btn-primary {
      width: 100%;
      padding: 1.1rem 1.5rem;
      border-radius: 1rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 4px 20px rgba(99,102,241,0.35);
      border: none;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(99,102,241,0.45); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled {
      background: linear-gradient(135deg, #9ca3af, #d1d5db);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      width: 100%;
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: #4f46e5;
      background: #eef2ff;
      border: 2px solid #818cf8;
      cursor: pointer;
      transition: background 0.15s;
    }
    .dark .btn-secondary { background: rgba(99,102,241,0.15); color: #a5b4fc; border-color: #6366f1; }
    .btn-secondary:hover { background: #e0e7ff; }
    .dark .btn-secondary:hover { background: rgba(99,102,241,0.25); }

    /* í° ì…ë ¥ í•„ë“œ */
    .input-lg {
      width: 100%;
      padding: 1rem 1.2rem;
      border-radius: 0.875rem;
      font-size: 1.25rem;
      border: 2.5px solid #e5e7eb;
      background: white;
      color: #111827;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .dark .input-lg { background: #1e293b; border-color: #475569; color: white; }
    .input-lg:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
    .input-lg::placeholder { color: #9ca3af; }
    .input-lg.error { border-color: #ef4444; }

    /* í° ë¼ë²¨ */
    .label-lg {
      display: block;
      font-size: 1.1rem;
      font-weight: 700;
      color: #374151;
      margin-bottom: 0.6rem;
    }
    .dark .label-lg { color: #d1d5db; }

    /* ë‹¨ê³„ ì œëª© */
    .step-title {
      font-size: 1.6rem;
      font-weight: 800;
      color: #1e1b4b;
      text-align: center;
      margin-bottom: 0.4rem;
    }
    .dark .step-title { color: #e0e7ff; }
    .step-desc {
      font-size: 1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 1.8rem;
    }
    .dark .step-desc { color: #94a3b8; }

    /* ì•„ì´ì½˜ ì›í˜• ë°°ê²½ */
    .step-icon {
      width: 72px; height: 72px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 1.2rem;
    }

    /* QR ìŠ¤ìºë„ˆ */
    #qr-reader { width: 100%; max-width: 400px; margin: 0 auto; }
    #qr-reader video { border-radius: 12px; }

    /* í™•ì¸ì¦ ì¹´ë“œ */
    .certificate-card {
      max-width: 400px; margin: 0 auto;
      border-radius: 16px; overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      background: white;
    }
    .certificate-header {
      background: linear-gradient(135deg, #10b981, #059669);
      padding: 24px 20px; text-align: center; color: white;
    }
    .certificate-body { padding: 20px; }
    .certificate-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .certificate-grid-item { padding: 10px; background: #f9fafb; border-radius: 8px; }
    .certificate-grid-item .label { font-size: 11px; color: #6b7280; margin-bottom: 2px; }
    .certificate-grid-item .value { font-size: 14px; font-weight: 600; color: #111827; }
    .certificate-meeting { margin-top: 12px; padding: 10px; background: #eef2ff; border-radius: 8px; text-align: center; }
    .certificate-meeting .label { font-size: 11px; color: #6366f1; margin-bottom: 2px; }
    .certificate-meeting .value { font-size: 14px; font-weight: 600; color: #4338ca; }
    .certificate-footer { margin-top: 16px; padding-top: 12px; border-top: 1px dashed #e5e7eb; text-align: center; font-size: 11px; color: #9ca3af; }
    .certificate-confirm-number {
      margin: 12px 0 16px; padding: 8px 16px;
      background: rgba(255,255,255,0.2); border-radius: 8px;
      font-family: monospace; font-size: 18px; font-weight: 700; letter-spacing: 2px;
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-bar {
      padding: 0.9rem 1rem;
      border-radius: 0.875rem;
      border: 2px solid transparent;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1.2rem;
    }
    .status-checking { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    .dark .status-checking { background: rgba(251,191,36,0.15); color: #fcd34d; border-color: #f59e0b; }
    .status-ready { background: #d1fae5; border-color: #34d399; color: #065f46; }
    .dark .status-ready { background: rgba(52,211,153,0.15); color: #34d399; border-color: #10b981; }
    .status-error { background: #fee2e2; border-color: #f87171; color: #991b1b; }
    .dark .status-error { background: rgba(248,113,113,0.15); color: #f87171; border-color: #ef4444; }

    /* ìœ„ì¹˜ ì§€ë„ */
    #locationMap {
      height: 250px; width: 100%; border-radius: 12px; z-index: 0;
    }
    .location-map-card { transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease; overflow: hidden; }
    .location-map-card.collapsed { max-height: 0; opacity: 0; margin: 0; }
    .location-map-card.expanded { max-height: 600px; opacity: 1; }
  </style>
</head>
<body class="gradient-bg min-h-screen font-sans antialiased text-gray-900 dark:text-white transition-colors duration-300">

  <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
  <button
    id="darkModeToggle"
    class="fixed top-4 right-4 z-50 p-3 rounded-full glass-card shadow-lg hover:scale-110 transition-transform duration-200"
    onclick="toggleDarkMode()"
  >
    <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
    </svg>
    <svg id="moonIcon" class="w-6 h-6 text-indigo-600 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
      <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
    </svg>
  </button>

  <div class="container mx-auto px-4 py-6 max-w-lg min-h-screen flex flex-col">

    <!-- í—¤ë”: í•­ìƒ í‘œì‹œ -->
    <div class="glass-card rounded-3xl shadow-2xl p-5 mb-5 animate-fade-in text-center">
      <img src="icons/logo-original.png" alt="ìš©ì¸ëŒ€í•™êµ" class="w-16 h-16 mx-auto mb-3 object-contain">
      <h1 id="meetingTitle" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">ì¶œì„ ì²´í¬</h1>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div id="mainCard" class="glass-card rounded-3xl shadow-2xl p-6 flex-1 animate-slide-up">

      <!-- ì•Œë¦¼ -->
      <div id="alertContainer" class="mb-2"></div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 0: ì‹œì‘ ëŒ€ê¸° (ì„¤ì • ë¡œë”© ì¤‘)         -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-loading" class="step-screen active text-center py-10">
        <div class="spinner w-12 h-12 mx-auto mb-4" style="border-width:4px;width:3rem;height:3rem;"></div>
        <p class="text-lg font-semibold text-gray-500 dark:text-gray-400">ì‹œìŠ¤í…œì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 1: ì‹œì‘ í™”ë©´                        -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-start" class="step-screen">
        <div class="step-icon bg-indigo-100 dark:bg-indigo-900/40">
          <svg class="w-10 h-10 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
        </div>
        <p class="step-title">ì¶œì„ ì²´í¬</p>
        <p class="step-desc">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶œì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
        <button class="btn-primary" onclick="goToNameStep()">ì¶œì„ ì²´í¬ ì‹œì‘</button>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 2: ì„±ëª… ì…ë ¥                        -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-name" class="step-screen">
        <p class="step-title">ì„±ëª… ì…ë ¥</p>
        <p class="step-desc">ë³¸ì¸ì˜ ì„±ëª…ì„ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
        <label class="label-lg" for="inputName">ì„±ëª… <span class="text-red-500">*</span></label>
        <input id="inputName" type="text" class="input-lg" placeholder="í™ê¸¸ë™" maxlength="20"
               autocomplete="name" autofocus
               oninput="validateStepInput('inputName','nameError','btn-name-next', 2)"
               onkeydown="if(event.key==='Enter'){document.getElementById('btn-name-next').click()}">
        <p id="nameError" class="text-red-500 text-sm mt-2 hidden"></p>
        <div class="mt-6 space-y-3">
          <button id="btn-name-next" class="btn-primary" onclick="goToDeptStep()" disabled>ë‹¤ìŒ</button>
          <button class="btn-secondary" onclick="goToScreen('screen-start')">ì´ì „</button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 3: ì†Œì† ì…ë ¥                        -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-dept" class="step-screen">
        <p class="step-title">ì†Œì† ì…ë ¥</p>
        <p class="step-desc">ì†Œì† í•™ê³¼ ë˜ëŠ” ë¶€ì„œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
        <label class="label-lg" for="inputDept">ì†Œì† <span class="text-red-500">*</span></label>
        <input id="inputDept" type="text" class="input-lg" placeholder="ê²½ì˜í•™ê³¼, êµë¬´íŒ€ ë“±" maxlength="50"
               autocomplete="organization-title" autofocus
               oninput="validateStepInput('inputDept','deptError','btn-dept-next', 2)"
               onkeydown="if(event.key==='Enter'){document.getElementById('btn-dept-next').click()}">
        <p id="deptError" class="text-red-500 text-sm mt-2 hidden"></p>
        <div class="mt-6 space-y-3">
          <button id="btn-dept-next" class="btn-primary" onclick="goToEmailOrVerifyStep()" disabled>ë‹¤ìŒ</button>
          <button class="btn-secondary" onclick="goToScreen('screen-name')">ì´ì „</button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 3b: ì´ë©”ì¼ ì…ë ¥ (email_enabled ì‹œë§Œ)-->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-email" class="step-screen">
        <p class="step-title">ì´ë©”ì¼ ì…ë ¥</p>
        <p class="step-desc">ì¶œì„ í™•ì¸ì¦ì„ ë°›ìœ¼ì‹¤ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”<br><span class="text-indigo-500 font-semibold">ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤</span></p>
        <label class="label-lg" for="inputEmail">ì´ë©”ì¼ <span class="text-gray-400 font-normal text-base">(ì„ íƒ)</span></label>
        <input id="inputEmail" type="email" class="input-lg" placeholder="example@yiu.ac.kr" maxlength="100"
               autocomplete="email" autofocus
               oninput="validateEmailInput()"
               onkeydown="if(event.key==='Enter'){document.getElementById('btn-email-next').click()}">
        <p id="emailError" class="text-red-500 text-sm mt-2 hidden"></p>
        <div class="mt-6 space-y-3">
          <button id="btn-email-next" class="btn-primary" onclick="goToVerifyStep()">ë‹¤ìŒ</button>
          <button class="btn-secondary" onclick="goToScreen('screen-dept')">ì´ì „</button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 4a: GPS ìœ„ì¹˜ í™•ì¸ (ì‹¤ì™¸ ëª¨ë“œ)       -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-gps" class="step-screen">
        <div class="step-icon bg-green-100 dark:bg-green-900/40">
          <svg class="w-10 h-10 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
        </div>
        <p class="step-title">ìœ„ì¹˜ í™•ì¸</p>
        <p class="step-desc">í˜„ì¬ ìœ„ì¹˜ê°€ íšŒì˜ì‹¤ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤</p>
        <div id="gpsStatusBar" class="status-bar status-checking">ğŸ“¡ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>

        <!-- ìœ„ì¹˜ ì˜¤ë¥˜ ì‹œ ì§€ë„ -->
        <div id="locationMapCard" class="location-map-card collapsed mb-4">
          <div class="p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800">
            <div class="flex items-center justify-between mb-3">
              <span class="font-semibold text-red-700 dark:text-red-400 text-sm">ğŸ“ ìœ„ì¹˜ ë¹„êµ</span>
              <button onclick="toggleLocationMap()" class="text-red-400 hover:text-red-600 transition-colors">âœ•</button>
            </div>
            <div id="locationMap" class="mb-3"></div>
            <div id="locationDebugInfo" class="text-xs text-red-600 dark:text-red-400 space-y-1"></div>
          </div>
        </div>

        <div class="space-y-3">
          <button id="btn-gps-submit" class="btn-primary" onclick="doSubmit()" disabled>ì¶œì„ ì²´í¬í•˜ê¸°</button>
          <button id="btn-gps-recheck" class="btn-secondary" onclick="recheckLocation()">ğŸ“¡ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸</button>
          <button class="btn-secondary" onclick="goBackFromVerify()">ì´ì „</button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 4b: QR ìŠ¤ìº” (ì‹¤ë‚´ ëª¨ë“œ)             -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-qr" class="step-screen">
        <div class="step-icon bg-indigo-100 dark:bg-indigo-900/40">
          <svg class="w-10 h-10 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
          </svg>
        </div>
        <p class="step-title">QR ì½”ë“œ ìŠ¤ìº”</p>
        <p class="step-desc">í™”ë©´ì— í‘œì‹œëœ QR ì½”ë“œë¥¼&nbsp;ìŠ¤ìº”í•´ ì£¼ì„¸ìš”</p>

        <div id="qr-reader" class="mb-4 rounded-2xl overflow-hidden border-2 border-gray-200 dark:border-slate-600"></div>

        <div id="qrControls" class="space-y-3">
          <button id="startScanBtn" onclick="startQRScanner()" class="btn-primary">ğŸ“· QR ì½”ë“œ ìŠ¤ìº” ì‹œì‘</button>
          <button id="stopScanBtn" onclick="stopQRScanner()" class="btn-secondary hidden">â¹ ìŠ¤ìº” ì¤‘ì§€</button>
        </div>

        <!-- QR ì„±ê³µ -->
        <div id="qrSuccessBadge" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/30 rounded-2xl border-2 border-green-300 dark:border-green-700 text-center">
          <div class="text-green-600 dark:text-green-400 text-3xl mb-1">âœ…</div>
          <p class="font-bold text-green-800 dark:text-green-300 text-lg">QR ì¸ì¦ ì™„ë£Œ!</p>
          <p id="qrSessionInfo" class="text-sm text-green-600 dark:text-green-500 mt-1"></p>
        </div>

        <div class="mt-4 space-y-3">
          <button id="btn-qr-submit" class="btn-primary hidden" onclick="doSubmit()">ì¶œì„ ì²´í¬í•˜ê¸°</button>
          <button class="btn-secondary" onclick="goBackFromVerify()">ì´ì „</button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP 5: ì™„ë£Œ í™”ë©´                        -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-done" class="step-screen">
        <div id="certificateCard" class="certificate-card">
          <div class="certificate-header">
            <div class="w-16 h-16 mx-auto mb-3 bg-white/20 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold mb-1">ì¶œì„ í™•ì¸ì¦</h3>
            <div class="certificate-confirm-number" id="certConfirmNumber">------</div>
          </div>
          <div class="certificate-body">
            <div class="certificate-grid">
              <div class="certificate-grid-item"><div class="label">ì„±ëª…</div><div class="value" id="certName">-</div></div>
              <div class="certificate-grid-item"><div class="label">ì†Œì†</div><div class="value" id="certDept">-</div></div>
              <div class="certificate-grid-item"><div class="label">ì¶œì„ ì‹œê°„</div><div class="value" id="certTime">-</div></div>
              <div class="certificate-grid-item"><div class="label">ì¸ì¦ ë°©ì‹</div><div class="value" id="certMethod">-</div></div>
            </div>
            <div class="certificate-meeting">
              <div class="label">íšŒì˜ëª…</div>
              <div class="value" id="certMeeting">-</div>
            </div>
            <div class="certificate-footer">ìš©ì¸ëŒ€í•™êµ êµì§ì› ì¶œì„ ì‹œìŠ¤í…œ</div>
          </div>
        </div>
        <div class="text-center mt-4">
          <p class="text-sm text-gray-500 dark:text-gray-400">ì¶œì„ì´ ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="text-center mt-3">
          <button onclick="captureAttendanceCertificate()"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 text-base">
            â¬‡ í™•ì¸ì¦ ì €ì¥
          </button>
        </div>
      </div>

      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <!-- STEP X: ìœ íš¨í•˜ì§€ ì•Šì€ QR                 -->
      <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="screen-invalid-qr" class="step-screen text-center py-6">
        <div class="step-icon bg-red-100 dark:bg-red-900/40">
          <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <p class="step-title">ìœ íš¨í•˜ì§€ ì•Šì€<br>QR ì½”ë“œ</p>
        <p class="step-desc">ì´ì „ íšŒì˜ì˜ QR ì½”ë“œì´ê±°ë‚˜ ë§Œë£Œëœ QR ì½”ë“œì…ë‹ˆë‹¤.<br>ê´€ë¦¬ìì—ê²Œ í˜„ì¬ íšŒì˜ QR ì½”ë“œë¥¼ ìš”ì²­í•´ ì£¼ì„¸ìš”.</p>
      </div>

      <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
      <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-4">
          <div class="spinner w-12 h-12 mx-auto mb-4"></div>
          <p id="loadingText" class="font-medium text-gray-700 dark:text-gray-300 text-lg">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>
    </div>

    <!-- ë‚´ ì¶œì„ í™•ì¸ -->
    <div class="glass-card rounded-3xl shadow-2xl mt-6 overflow-hidden animate-fade-in">
      <div class="attendance-check-toggle flex items-center justify-between p-5" onclick="toggleAttendanceCheck()">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
            <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <div>
            <p class="font-bold text-gray-900 dark:text-white">ë‚´ ì¶œì„ í™•ì¸</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">ì´ë¦„ê³¼ ì†Œì†ìœ¼ë¡œ ì¶œì„ ì—¬ë¶€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
          </div>
        </div>
        <svg id="attendanceCheckArrow" class="w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
      <div id="attendanceCheckContent" class="attendance-check-content">
        <div class="px-5 pb-5 space-y-4">
          <div>
            <label for="checkName" class="label-lg">ì„±ëª…</label>
            <input type="text" id="checkName" placeholder="í™ê¸¸ë™" maxlength="20"
              class="input-lg" style="font-size:1rem;padding:0.75rem 1rem;">
          </div>
          <div>
            <label for="checkDept" class="label-lg">ì†Œì†</label>
            <input type="text" id="checkDept" placeholder="ê²½ì˜í•™ê³¼, êµë¬´íŒ€ ë“±" maxlength="50"
              class="input-lg" style="font-size:1rem;padding:0.75rem 1rem;">
          </div>
          <button onclick="checkMyAttendance()" id="checkAttendanceBtn"
            class="btn-primary" style="font-size:1rem;padding:0.85rem;">ì¶œì„ ì¡°íšŒ</button>
          <div id="attendanceCheckResult"></div>
        </div>
      </div>
    </div>

    <!-- í‘¸í„° -->
    <div class="text-center py-4 text-white/70 text-sm">
      <p>ìš©ì¸ëŒ€í•™êµ êµì§ì› ì¶œì„ ì‹œìŠ¤í…œ &copy; <script>document.write(new Date().getFullYear())</script></p>
    </div>
  </div>


  <script>
    // =====================================================================
    // ì„¤ì • ë° ì „ì—­ ìƒíƒœ
    // =====================================================================
    const CONFIG = {
      BACKEND_URL: 'https://script.google.com/macros/s/AKfycbyYZ5xoqKL36ox70sg-4nvK6jDTAJIuHvLK7A1EoQQxxyOe3doSaIp2hlEEDn3xXdkGAQ/exec',
      DEFAULT_LOCATION: { latitude: 37.2420, longitude: 127.1775, radius: 1200 },
      REQUEST_TIMEOUT: 30000,
      QR_TOKEN_PREFIX: 'YU_QR_'
    };

    let state = {
      isSystemReady: false,
      isCompleted: false,
      isSubmitting: false,
      isQrVerified: false,
      isLocationValid: false,
      emailEnabled: true,
      locationMode: 'outdoor',
      locationSettings: { latitude: 37.2420, longitude: 127.1775, radius: 1200 },
      lastKnownPosition: null,
      locationMap: null,
      deviceInfo: null,
      qrScanner: null,
      qrToken: null,
      deviceId: null,
      currentEventId: null,
      preventProxy: false,
      qrEntryFlag: false,
      qrEventId: null
    };

    // =====================================================================
    // ì´ˆê¸°í™”
    // =====================================================================
    document.addEventListener('DOMContentLoaded', function () {
      initializeDarkMode();
      state.deviceId = getDeviceId();
      collectDeviceInfo();

      const urlParams = new URLSearchParams(window.location.search);
      state.qrEntryFlag = urlParams.get('qr') === '1';
      state.qrEventId = urlParams.get('eid') || null;
      if (state.qrEntryFlag) history.replaceState(null, '', window.location.pathname);

      loadSettingsFromServer();
      fetchCurrentEventId();
    });

    function getDeviceId() {
      let id = localStorage.getItem('yiu_device_id');
      if (!id) {
        id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('yiu_device_id', id);
      }
      return id;
    }

    function collectDeviceInfo() {
      state.deviceInfo = {
        userAgent: navigator.userAgent || 'unknown',
        platform: navigator.platform || 'unknown',
        language: navigator.language || 'ko',
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Seoul',
        screenInfo: screen.width + 'x' + screen.height + 'x' + (screen.colorDepth || 24),
        touchPoints: navigator.maxTouchPoints || 0,
        timestamp: Date.now()
      };
    }

    function initializeDarkMode() {
      const isDark = localStorage.getItem('darkMode') === 'true' ||
                     (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (isDark) document.documentElement.classList.add('dark');
    }

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
    }

    // =====================================================================
    // ì„¤ì • ë¡œë“œ
    // =====================================================================
    function loadSettingsFromServer() {
      callGoogleScript('getSettings', null)
        .then(result => {
          if (result && typeof result === 'object') applySettings(result);
          else showStartScreen('outdoor');
        })
        .catch(() => showStartScreen('outdoor'));
    }

    function applySettings(settings) {
      if (settings.meeting_title) {
        const titleEl = document.getElementById('meetingTitle');
        if (titleEl) titleEl.textContent = settings.meeting_title;
        const startTitleEl = document.getElementById('startTitle');
        if (startTitleEl) startTitleEl.textContent = settings.meeting_title;
      }
      if (settings.target_latitude)  state.locationSettings.latitude  = parseFloat(settings.target_latitude);
      if (settings.target_longitude) state.locationSettings.longitude = parseFloat(settings.target_longitude);
      if (settings.location_radius)  state.locationSettings.radius    = parseFloat(settings.location_radius);

      state.preventProxy = settings.prevent_proxy_attendance === true || settings.prevent_proxy_attendance === 'true';
      state.emailEnabled = settings.email_enabled !== 'false';
      state.locationMode = settings.location_mode || 'outdoor';

      if (state.currentEventId && hasAlreadyAttended(state.currentEventId)) {
        showDoneFromStorage(state.currentEventId);
        return;
      }

      if (state.locationMode === 'indoor' && state.qrEntryFlag && !state.isCompleted) {
        if (!state.qrEventId || state.qrEventId !== settings.current_event_id) {
          goToScreen('screen-invalid-qr');
        } else {
          state.isQrVerified = true;
          state.qrToken = state.qrEventId;
          showStartScreen('indoor');
        }
        return;
      }

      showStartScreen(state.locationMode);
    }

    function showStartScreen(mode) {
      state.locationMode = mode;
      state.isSystemReady = true;
      goToScreen('screen-start');
    }

    function fetchCurrentEventId() {
      callGoogleScript('getSystemStatus', null)
        .then(result => {
          if (result && result.success && result.currentEventId) {
            state.currentEventId = result.currentEventId;
            if (hasAlreadyAttended(state.currentEventId)) {
              showDoneFromStorage(state.currentEventId);
            }
          }
        })
        .catch(() => {});
    }

    // =====================================================================
    // ë‹¨ê³„ë³„ í™”ë©´ ì „í™˜
    // =====================================================================
    function goToScreen(id) {
      document.querySelectorAll('.step-screen').forEach(el => el.classList.remove('active'));
      const target = document.getElementById(id);
      if (target) {
        target.classList.add('active');
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function goToNameStep() {
      goToScreen('screen-name');
      setTimeout(() => {
        const el = document.getElementById('inputName');
        if (el) el.focus();
      }, 300);
    }

    function goToDeptStep() {
      const name = document.getElementById('inputName').value.trim();
      if (name.length < 2) { showStepError('nameError', 'ì„±ëª…ì„ 2ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      hideStepError('nameError');
      goToScreen('screen-dept');
      setTimeout(() => {
        const el = document.getElementById('inputDept');
        if (el) el.focus();
      }, 300);
    }

    function goToEmailOrVerifyStep() {
      const dept = document.getElementById('inputDept').value.trim();
      if (dept.length < 2) { showStepError('deptError', 'ì†Œì†ì„ 2ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      hideStepError('deptError');
      if (state.emailEnabled) {
        goToScreen('screen-email');
        setTimeout(() => {
          const el = document.getElementById('inputEmail');
          if (el) el.focus();
        }, 300);
      } else {
        goToVerifyStep();
      }
    }

    function goToVerifyStep() {
      if (state.emailEnabled) {
        const email = document.getElementById('inputEmail').value.trim();
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showStepError('emailError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');
          return;
        }
        hideStepError('emailError');
      }
      if (state.locationMode === 'indoor') {
        if (state.isQrVerified) {
          // QR URLë¡œ ì§„ì… â†’ ì¬ì´¬ì˜ ë¶ˆí•„ìš”, ë°”ë¡œ ì œì¶œ
          doSubmit();
          return;
        }
        goToScreen('screen-qr');
      } else {
        goToScreen('screen-gps');
        setTimeout(startLocationCheck, 400);
      }
    }

    function goBackFromVerify() {
      if (state.locationMode === 'indoor') stopQRScanner();
      if (state.emailEnabled) goToScreen('screen-email');
      else goToScreen('screen-dept');
    }

    function validateStepInput(inputId, errorId, btnId, minLen) {
      const val  = document.getElementById(inputId).value.trim();
      const btn  = document.getElementById(btnId);
      const errEl = document.getElementById(errorId);
      if (val.length >= minLen) {
        if (btn)  btn.disabled = false;
        if (errEl) errEl.classList.add('hidden');
      } else {
        if (btn) btn.disabled = true;
      }
    }

    function validateEmailInput() {
      const email = document.getElementById('inputEmail').value.trim();
      const errEl = document.getElementById('emailError');
      const btn   = document.getElementById('btn-email-next');
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        if (errEl) { errEl.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); }
        if (btn)  btn.disabled = true;
      } else {
        if (errEl) errEl.classList.add('hidden');
        if (btn)  btn.disabled = false;
      }
    }

    function showStepError(errorId, msg) {
      const el = document.getElementById(errorId);
      if (el) { el.textContent = msg; el.classList.remove('hidden'); }
    }

    function hideStepError(errorId) {
      const el = document.getElementById(errorId);
      if (el) el.classList.add('hidden');
    }

    // =====================================================================
    // GPS (ì‹¤ì™¸ ëª¨ë“œ)
    // =====================================================================
    function startLocationCheck() {
      if (!navigator.geolocation) {
        setGpsStatus('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤', 'error');
        return;
      }
      setGpsStatus('ğŸ“¡ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'checking');
      navigator.geolocation.getCurrentPosition(
        handleLocationSuccess, handleLocationError,
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
      );
    }

    function handleLocationSuccess(position) {
      state.lastKnownPosition = position;
      const { latitude: uLat, longitude: uLng, accuracy } = position.coords;
      const { latitude: tLat, longitude: tLng } = state.locationSettings;
      const dist    = calculateDistance(uLat, uLng, tLat, tLng);
      const allowed = calculateAllowedRadius(accuracy);
      const gpsBtn  = document.getElementById('btn-gps-submit');

      if (dist <= allowed) {
        state.isLocationValid = true;
        hideLocationMap();
        const msg = 'âœ… ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ' + (dist < 100 ? ' â€” ë§¤ìš° ê°€ê¹Œì›€' : ' â€” ' + Math.round(dist) + 'm');
        setGpsStatus(msg, 'ready');
        if (gpsBtn) gpsBtn.disabled = false;
      } else {
        state.isLocationValid = false;
        setGpsStatus('âŒ íšŒì˜ì‹¤ì—ì„œ ' + Math.round(dist) + 'm ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤', 'error');
        if (gpsBtn) gpsBtn.disabled = true;
        showLocationMap(uLat, uLng, tLat, tLng, dist, allowed, accuracy);
      }
    }

    function handleLocationError(error) {
      state.isLocationValid = false;
      const msgs = {
        1: 'ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”',
        2: 'GPS ì‹ í˜¸ê°€ ì•½í•©ë‹ˆë‹¤. ì°½ê°€ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”',
        3: 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤'
      };
      setGpsStatus('âš ï¸ ' + (msgs[error.code] || 'ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'), 'error');
      const gpsBtn = document.getElementById('btn-gps-submit');
      if (gpsBtn) gpsBtn.disabled = true;
    }

    function recheckLocation() {
      const btn = document.getElementById('btn-gps-recheck');
      if (btn) { btn.disabled = true; btn.textContent = 'í™•ì¸ ì¤‘...'; }
      setGpsStatus('ğŸ“¡ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'checking');
      navigator.geolocation.getCurrentPosition(
        pos => {
          if (btn) { btn.disabled = false; btn.textContent = 'ğŸ“¡ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸'; }
          handleLocationSuccess(pos);
        },
        err => {
          if (btn) { btn.disabled = false; btn.textContent = 'ğŸ“¡ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸'; }
          handleLocationError(err);
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
      );
    }

    function setGpsStatus(msg, type) {
      const el = document.getElementById('gpsStatusBar');
      if (!el) return;
      el.className = 'status-bar status-' + type;
      el.textContent = msg;
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R    = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a    = Math.sin(dLat / 2) ** 2 +
                   Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function calculateAllowedRadius(accuracy) {
      const mob = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      let m = mob ? 1.2 : 1.8;
      if (accuracy > 500) m *= 1.3;
      else if (accuracy > 200) m *= 1.1;
      return Math.max(300, Math.min(2500, Math.round(state.locationSettings.radius * m)));
    }

    // ---- ìœ„ì¹˜ ì§€ë„ ----
    function showLocationMap(uLat, uLng, tLat, tLng, dist, allowed, acc) {
      const card = document.getElementById('locationMapCard');
      if (!card) return;
      card.classList.remove('collapsed');
      card.classList.add('expanded');
      if (state.locationMap) { state.locationMap.remove(); state.locationMap = null; }
      setTimeout(() => {
        if (typeof L === 'undefined') return;
        const map = L.map('locationMap', { zoomControl: true, attributionControl: false });
        state.locationMap = map;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        function mkIcon(color, svgPath) {
          return L.divIcon({
            className: '',
            html: '<div style="width:32px;height:32px;border-radius:50%;background:' + color + ';border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center">' +
                  '<svg width=16 height=16 viewBox="0 0 24 24" fill=white><path d="' + svgPath + '"/></svg></div>',
            iconSize: [32, 32], iconAnchor: [16, 32]
          });
        }
        const mkT = mkIcon('#4f46e5', 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z');
        const mkU = mkIcon('#ef4444', 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z');

        L.marker([tLat, tLng], { icon: mkT }).addTo(map).bindPopup('<b>íšŒì˜ì‹¤</b>');
        L.marker([uLat, uLng], { icon: mkU }).addTo(map).bindPopup('<b>ë‚´ ìœ„ì¹˜</b>');
        L.circle([tLat, tLng], { radius: allowed, color: '#4f46e5', fillColor: '#818cf8', fillOpacity: 0.1, weight: 2, dashArray: '5,5' }).addTo(map);
        L.circle([uLat, uLng], { radius: acc, color: '#ef4444', fillColor: '#fca5a5', fillOpacity: 0.1, weight: 1 }).addTo(map);
        L.polyline([[uLat, uLng], [tLat, tLng]], { color: '#f59e0b', weight: 2, dashArray: '8,4' }).addTo(map);
        map.fitBounds(L.latLngBounds([[uLat, uLng], [tLat, tLng]]), { padding: [40, 40] });

        const dbg = document.getElementById('locationDebugInfo');
        if (dbg) dbg.innerHTML = 'ê±°ë¦¬: <b>' + Math.round(dist) + 'm</b> / í—ˆìš©: <b>' + allowed + 'm</b> / ì •í™•ë„: <b>' + Math.round(acc) + 'm</b>';
      }, 100);
    }

    function hideLocationMap() {
      const card = document.getElementById('locationMapCard');
      if (card) { card.classList.remove('expanded'); card.classList.add('collapsed'); }
    }

    function toggleLocationMap() {
      const card = document.getElementById('locationMapCard');
      if (!card) return;
      if (card.classList.contains('expanded')) {
        hideLocationMap();
      } else {
        card.classList.remove('collapsed');
        card.classList.add('expanded');
        if (state.locationMap) setTimeout(() => state.locationMap.invalidateSize(), 400);
      }
    }

    // =====================================================================
    // QR ìŠ¤ìºë„ˆ (ì‹¤ë‚´ ëª¨ë“œ) â€” GPS ì½”ë“œ ì—†ìŒ
    // =====================================================================
    function startQRScanner() {
      if (state.qrScanner) stopQRScanner();
      const startBtn = document.getElementById('startScanBtn');
      const stopBtn  = document.getElementById('stopScanBtn');
      if (startBtn) startBtn.classList.add('hidden');
      if (stopBtn)  stopBtn.classList.remove('hidden');
      const badge = document.getElementById('qrSuccessBadge');
      const subBtn = document.getElementById('btn-qr-submit');
      if (badge) badge.classList.add('hidden');
      if (subBtn) subBtn.classList.add('hidden');

      if (typeof Html5Qrcode === 'undefined') {
        showToast('QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'warning');
        if (startBtn) startBtn.classList.remove('hidden');
        if (stopBtn)  stopBtn.classList.add('hidden');
        return;
      }

      state.qrScanner = new Html5Qrcode('qr-reader');
      state.qrScanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onQRCodeSuccess,
        () => {}
      ).catch(() => {
        showToast('ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', 'error');
        if (startBtn) startBtn.classList.remove('hidden');
        if (stopBtn)  stopBtn.classList.add('hidden');
      });
    }

    function stopQRScanner() {
      if (state.qrScanner) {
        state.qrScanner.stop()
          .then(() => { state.qrScanner.clear(); state.qrScanner = null; })
          .catch(() => { state.qrScanner = null; });
      }
      const startBtn = document.getElementById('startScanBtn');
      const stopBtn  = document.getElementById('stopScanBtn');
      if (startBtn) startBtn.classList.remove('hidden');
      if (stopBtn)  stopBtn.classList.add('hidden');
    }

    function onQRCodeSuccess(decodedText) {
      stopQRScanner();
      const isValidUrl = decodedText.startsWith('http') && (
        decodedText.includes('index.html') ||
        decodedText.includes('script.google.com') ||
        decodedText.includes(window.location.hostname)
      );
      if (isValidUrl || decodedText.startsWith(CONFIG.QR_TOKEN_PREFIX)) {
        state.isQrVerified = true;
        state.qrToken = decodedText;
        showQrSuccess();
      } else {
        showToast('ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.', 'error');
        const startBtn = document.getElementById('startScanBtn');
        if (startBtn) startBtn.classList.remove('hidden');
      }
    }

    function showQrSuccess() {
      const badge  = document.getElementById('qrSuccessBadge');
      const info   = document.getElementById('qrSessionInfo');
      const subBtn = document.getElementById('btn-qr-submit');
      if (badge)  badge.classList.remove('hidden');
      if (info)   info.textContent = 'QR ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
      if (subBtn) subBtn.classList.remove('hidden');
      showToast('QR ì½”ë“œ ì¸ì¦ ì™„ë£Œ!', 'success');
    }

    // =====================================================================
    // ì¶œì„ ì œì¶œ
    // =====================================================================
    function doSubmit() {
      if (state.isSubmitting || state.isCompleted) return;

      if (state.currentEventId && hasAlreadyAttended(state.currentEventId)) {
        showDoneFromStorage(state.currentEventId);
        return;
      }

      const name  = document.getElementById('inputName').value.trim();
      const dept  = document.getElementById('inputDept').value.trim();
      const email = state.emailEnabled
        ? (document.getElementById('inputEmail').value.trim())
        : '';

      state.isSubmitting = true;
      showLoading(true, 'ì¶œì„ ì •ë³´ë¥¼ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

      const buildAndSend = (position) => {
        const data = {
          name,
          department: dept,
          email,
          latitude:   position ? position.coords.latitude  : 0,
          longitude:  position ? position.coords.longitude : 0,
          accuracy:   position ? position.coords.accuracy  : -1,
          timestamp:  new Date().toISOString(),
          deviceId:   state.deviceId,
          locationMode: state.locationMode,
          qrToken:    state.qrToken || '',
          qrVerified: state.isQrVerified,
          ...(state.deviceInfo || {})
        };

        callGoogleScript('saveAttendance', data)
          .then(result => {
            state.isSubmitting = false;
            showLoading(false);
            if (result && result.success) {
              completeAttendance(result, name, dept);
            } else {
              const msg = (result && result.error) || 'ì¶œì„ ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              showToast(msg, 'error');
              if (state.locationMode === 'outdoor') setGpsStatus('âŒ ' + msg, 'error');
            }
          })
          .catch(() => {
            state.isSubmitting = false;
            showLoading(false);
            showToast('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
          });
      };

      if (state.locationMode === 'outdoor') {
        if (state.lastKnownPosition) {
          buildAndSend(state.lastKnownPosition);
        } else {
          navigator.geolocation.getCurrentPosition(
            pos => { state.lastKnownPosition = pos; buildAndSend(pos); },
            ()  => {
              state.isSubmitting = false;
              showLoading(false);
              showToast('ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            },
            { enableHighAccuracy: true, timeout: 15000 }
          );
        }
      } else {
        // ì‹¤ë‚´(QR) ëª¨ë“œ: GPS ë¶ˆí•„ìš”
        buildAndSend(null);
      }
    }

    function completeAttendance(result, name, dept) {
      state.isCompleted = true;
      const now          = new Date();
      const methodText   = state.locationMode === 'indoor' ? 'QR ì½”ë“œ' : 'GPS ìœ„ì¹˜';
      const meetingEl    = document.getElementById('meetingTitle');
      const meetingTitle = meetingEl ? meetingEl.textContent : 'êµì§ì› íšŒì˜';
      const confirmNum   = generateConfirmationNumber(now);

      const info = {
        name, dept,
        time:          now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
        method:        methodText,
        meeting:       meetingTitle,
        confirmNumber: confirmNum
      };

      if (state.currentEventId) markAsAttended(state.currentEventId, info);
      if (result.eventId && result.eventId !== state.currentEventId) markAsAttended(result.eventId, info);

      fillCertificate(info);
      goToScreen('screen-done');
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    function fillCertificate(info) {
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      set('certName',          info.name);
      set('certDept',          info.dept);
      set('certTime',          info.time);
      set('certMethod',        info.method);
      set('certMeeting',       info.meeting);
      set('certConfirmNumber', info.confirmNumber);
    }

    function generateConfirmationNumber(date) {
      const yy = String(date.getFullYear()).slice(-2);
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return yy + mm + dd + '-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');
    }

    // =====================================================================
    // ì´ë¯¸ ì¶œì„ ì™„ë£Œ ì²˜ë¦¬
    // =====================================================================
    function hasAlreadyAttended(eventId) {
      return localStorage.getItem('yiu_attended_' + eventId) === 'true';
    }

    function markAsAttended(eventId, info) {
      if (!eventId) return;
      localStorage.setItem('yiu_attended_' + eventId, 'true');
      if (info) localStorage.setItem('yiu_attended_info_' + eventId, JSON.stringify(info));
    }

    function showDoneFromStorage(eventId) {
      state.isCompleted = true;
      try {
        const saved = localStorage.getItem('yiu_attended_info_' + eventId);
        if (saved) {
          fillCertificate(JSON.parse(saved));
        } else {
          const meetingEl = document.getElementById('meetingTitle');
          fillCertificate({
            name: '-', dept: '-', time: '-', method: '-',
            meeting: meetingEl ? meetingEl.textContent : 'êµì§ì› íšŒì˜',
            confirmNumber: 'ì´ë¯¸ ì¶œì„ ì™„ë£Œ'
          });
        }
      } catch (e) {}
      goToScreen('screen-done');
    }

    // =====================================================================
    // í™•ì¸ì¦ ì €ì¥
    // =====================================================================
    function captureAttendanceCertificate() {
      const card = document.getElementById('certificateCard');
      if (!card) return;
      showToast('í™•ì¸ì¦ì„ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
      if (typeof html2canvas === 'undefined') {
        showToast('ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      html2canvas(card, { scale: 2, useCORS: true, backgroundColor: '#ffffff' })
        .then(canvas => {
          const link = document.createElement('a');
          const now  = new Date();
          link.download = 'ì¶œì„í™•ì¸ì¦_' + now.toLocaleDateString('ko-KR').replace(/[. ]/g, '').replace(/.$/, '') + '.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
          showToast('í™•ì¸ì¦ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        })
        .catch(() => showToast('í™•ì¸ì¦ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'));
    }

    // =====================================================================
    // ë‚´ ì¶œì„ í™•ì¸ (ì•„ì½”ë””ì–¸)
    // =====================================================================
    function toggleAttendanceCheck() {
      const content = document.getElementById('attendanceCheckContent');
      const arrow   = document.getElementById('attendanceCheckArrow');
      if (!content) return;
      const expanded = content.classList.toggle('expanded');
      if (arrow) arrow.style.transform = expanded ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function checkMyAttendance() {
      const name = document.getElementById('checkName').value.trim();
      const dept = document.getElementById('checkDept').value.trim();
      if (name.length < 2) { showToast('ì„±ëª…ì„ 2ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'warning'); return; }
      if (dept.length < 2) { showToast('ì†Œì†ì„ 2ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'warning'); return; }

      const btn = document.getElementById('checkAttendanceBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'ì¡°íšŒ ì¤‘...'; }

      callGoogleScript('checkAttendance', { name, department: dept })
        .then(result => {
          if (btn) { btn.disabled = false; btn.textContent = 'ì¶œì„ ì¡°íšŒ'; }
          displayAttendanceCheckResult(result);
        })
        .catch(() => {
          if (btn) { btn.disabled = false; btn.textContent = 'ì¶œì„ ì¡°íšŒ'; }
          displayAttendanceCheckResult({ success: false, error: 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
        });
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    function displayAttendanceCheckResult(result) {
      const c = document.getElementById('attendanceCheckResult');
      if (!c) return;
      if (result && result.success && result.found) {
        const r = result.record;
        c.innerHTML =
          '<div class="p-4 rounded-xl bg-green-50 dark:bg-green-900/30 border-2 border-green-200 dark:border-green-800 mt-2">' +
            '<p class="font-bold text-green-800 dark:text-green-300 mb-2">âœ… ì¶œì„ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤</p>' +
            '<div class="grid grid-cols-2 gap-2 text-sm">' +
              '<div class="p-2 bg-white dark:bg-slate-700 rounded-lg"><div class="text-xs text-gray-400">ì„±ëª…</div><div class="font-semibold">' + escapeHtml(r.name) + '</div></div>' +
              '<div class="p-2 bg-white dark:bg-slate-700 rounded-lg"><div class="text-xs text-gray-400">ì†Œì†</div><div class="font-semibold">' + escapeHtml(r.department) + '</div></div>' +
              '<div class="p-2 bg-white dark:bg-slate-700 rounded-lg"><div class="text-xs text-gray-400">ì¶œì„ ì‹œê°„</div><div class="font-semibold">' + escapeHtml(r.time) + '</div></div>' +
              '<div class="p-2 bg-white dark:bg-slate-700 rounded-lg"><div class="text-xs text-gray-400">íšŒì˜ëª…</div><div class="font-semibold">' + escapeHtml(r.meetingTitle || '-') + '</div></div>' +
            '</div>' +
          '</div>';
      } else if (result && result.success && !result.found) {
        c.innerHTML =
          '<div class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/30 border-2 border-amber-200 mt-2">' +
            '<p class="font-bold text-amber-800 dark:text-amber-300">âš ï¸ ì¶œì„ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>' +
            '<p class="text-sm mt-1 text-amber-600">ì´ë¦„ê³¼ ì†Œì†ì´ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>' +
          '</div>';
      } else {
        c.innerHTML =
          '<div class="p-4 rounded-xl bg-red-50 dark:bg-red-900/30 border-2 border-red-200 mt-2">' +
            '<p class="font-bold text-red-700 dark:text-red-400">âŒ ì¡°íšŒ ì‹¤íŒ¨</p>' +
            '<p class="text-sm mt-1">' + escapeHtml((result && result.error) || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') + '</p>' +
          '</div>';
      }
    }

    // =====================================================================
    // Google Apps Script í†µì‹  (JSONP + fetch í´ë°±)
    // =====================================================================
    function callGoogleScript(method, params) {
      let url = CONFIG.BACKEND_URL + '?method=' + encodeURIComponent(method);
      if (params) url += '&params=' + encodeURIComponent(JSON.stringify(params));
      return callViaJsonp(url).catch(() => callViaFetch(url));
    }

    function callViaFetch(baseUrl) {
      const url = baseUrl + '&callback=_cb';
      return fetch(url, { redirect: 'follow' })
        .then(res => { if (!res.ok) throw new Error('HTTP ' + res.status); return res.text(); })
        .then(text => JSON.parse(text.replace(/^_cb\(/, '').replace(/\);\s*$/, '')));
    }

    function callViaJsonp(baseUrl) {
      return new Promise((resolve, reject) => {
        const cbName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
        const tid = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, CONFIG.REQUEST_TIMEOUT);
        function cleanup() {
          clearTimeout(tid);
          delete window[cbName];
          const s = document.getElementById(cbName);
          if (s) s.remove();
        }
        window[cbName] = result => { cleanup(); resolve(result); };
        const script = document.createElement('script');
        script.id = cbName;
        script.onerror = () => { cleanup(); reject(new Error('network')); };
        script.src = baseUrl + '&callback=' + cbName;
        document.head.appendChild(script);
      });
    }

    // =====================================================================
    // UI í—¬í¼
    // =====================================================================
    function showToast(message, type) {
      type = type || 'info';
      const container = document.getElementById('alertContainer');
      if (!container) return;
      const colors = {
        success: 'bg-green-50 dark:bg-green-900/50 border-green-200 dark:border-green-800 text-green-800 dark:text-green-300',
        error:   'bg-red-50 dark:bg-red-900/50 border-red-200 dark:border-red-800 text-red-800 dark:text-red-300',
        warning: 'bg-amber-50 dark:bg-amber-900/50 border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-300',
        info:    'bg-blue-50 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-300'
      };
      const toast = document.createElement('div');
      toast.className = 'p-4 rounded-xl border-2 mb-3 ' + (colors[type] || colors.info);
      toast.style.animation = 'stepIn 0.3s ease-out';
      toast.innerHTML =
        '<div class="flex items-start gap-3">' +
          '<div class="flex-1 text-sm font-medium">' + message + '</div>' +
          '<button onclick="this.parentElement.parentElement.remove()" ' +
                  'class="flex-shrink-0 opacity-60 hover:opacity-100 text-lg leading-none">&times;</button>' +
        '</div>';
      container.appendChild(toast);
      const delay = type === 'success' ? 5000 : 8000;
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, delay);
    }

    function showLoading(show, text) {
      const overlay = document.getElementById('loadingOverlay');
      if (!overlay) return;
      if (show) {
        const textEl = document.getElementById('loadingText');
        if (textEl) textEl.textContent = text || 'ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...';
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    function updateStatus() {} // í•˜ìœ„ í˜¸í™˜ noop

    console.log('ìš©ì¸ëŒ€í•™êµ êµì§ì› ì¶œì„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ v2.2.0');
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="용인대학교 교직원 회의 출석 시스템 - QR코드와 GPS를 통한 간편한 출석 체크">

  <title>용인대학교 출석체크</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'pulse-slow': 'pulse 3s infinite',
            'bounce-slow': 'bounce 2s infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <!-- html5-qrcode for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    /* 커스텀 그라데이션 배경 */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B8DD6 100%);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .dark .gradient-bg {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e3a5f 100%);
    }

    /* 글래스모피즘 카드 */
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .dark .glass-card {
      background: rgba(30, 41, 59, 0.95);
    }

    /* QR 스캐너 스타일 */
    #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    #qr-reader video {
      border-radius: 12px;
    }

    /* 토스트 애니메이션 */
    .toast-enter {
      animation: toastEnter 0.3s ease-out;
    }

    .toast-exit {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes toastEnter {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* 입력 필드 포커스 효과 */
    .input-focus-ring:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    /* 스피너 */
    .spinner {
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 탭 인디케이터 */
    .tab-indicator {
      transition: transform 0.3s ease, width 0.3s ease;
    }

    /* 모바일 최적화 */
    @media (max-width: 640px) {
      .mobile-padding {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }

    /* 스크롤바 숨김 */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen font-sans antialiased text-gray-900 dark:text-white transition-colors duration-300">

  <!-- 다크모드 토글 버튼 -->
  <button
    id="darkModeToggle"
    class="fixed top-4 right-4 z-50 p-3 rounded-full glass-card shadow-lg hover:scale-110 transition-transform duration-200"
    onclick="toggleDarkMode()"
  >
    <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
    </svg>
    <svg id="moonIcon" class="w-6 h-6 text-indigo-600 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
      <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
    </svg>
  </button>

  <div class="container mx-auto px-4 py-6 max-w-lg min-h-screen flex flex-col">

    <!-- 헤더 카드 -->
    <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6 animate-fade-in">
      <div class="text-center">
        <!-- 로고/아이콘 -->
        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>

        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">용인대학교</h1>
        <h2 id="meetingTitle" class="text-lg font-medium text-indigo-600 dark:text-indigo-400 mb-2">교직원 회의 출석</h2>
        <p id="meetingDescription" class="text-sm text-gray-500 dark:text-gray-400">QR 코드 스캔 또는 직접 입력으로 출석하세요</p>
      </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="glass-card rounded-3xl shadow-2xl p-6 flex-1 animate-slide-up">

      <!-- 알림 컨테이너 -->
      <div id="alertContainer" class="mb-4"></div>

      <!-- 상태 표시 -->
      <div id="statusIndicator" class="mb-6 p-4 rounded-2xl bg-gray-100 dark:bg-slate-700 border-2 border-gray-200 dark:border-slate-600 transition-all duration-300">
        <div class="flex items-center justify-center gap-3">
          <div class="spinner w-5 h-5"></div>
          <span class="font-medium text-gray-600 dark:text-gray-300">시스템을 준비하고 있습니다...</span>
        </div>
      </div>

      <!-- 탭 네비게이션 -->
      <div class="flex bg-gray-100 dark:bg-slate-700 rounded-xl p-1 mb-6">
        <button
          id="tabManual"
          class="flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm"
          onclick="switchTab('manual')"
        >
          직접 입력
        </button>
        <button
          id="tabQR"
          class="flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
          onclick="switchTab('qr')"
        >
          QR 스캔
        </button>
      </div>

      <!-- 직접 입력 탭 -->
      <div id="manualTab" class="tab-content">
        <form id="attendanceForm" class="space-y-5">
          <!-- 성명 -->
          <div>
            <label for="name" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
              성명 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              placeholder="홍길동"
              maxlength="20"
              required
              class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none input-focus-ring transition-all duration-200"
            >
            <p id="name-validation" class="mt-1.5 text-sm text-red-500 hidden"></p>
          </div>

          <!-- 소속 -->
          <div>
            <label for="department" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
              소속 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="department"
              placeholder="경영학과, 교무팀 등"
              maxlength="50"
              required
              class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none input-focus-ring transition-all duration-200"
            >
            <p id="department-validation" class="mt-1.5 text-sm text-red-500 hidden"></p>
          </div>

          <!-- 이메일 (선택) -->
          <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
              이메일 <span class="text-gray-400 font-normal">(선택)</span>
            </label>
            <input
              type="email"
              id="email"
              placeholder="example@yiu.ac.kr"
              maxlength="100"
              autocomplete="email"
              class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none input-focus-ring transition-all duration-200"
            >
            <p class="mt-1.5 text-xs text-gray-400 dark:text-gray-500">출석 확인 이메일을 받으시려면 입력하세요</p>
            <p id="email-validation" class="mt-1 text-sm text-red-500 hidden"></p>
          </div>

          <!-- 출석 버튼 -->
          <button
            type="submit"
            id="submitBtn"
            disabled
            class="w-full py-4 px-6 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl disabled:shadow-none transform hover:-translate-y-0.5 disabled:translate-y-0 transition-all duration-200"
          >
            <span id="submitBtnText">위치 확인 후 출석 체크</span>
          </button>

          <!-- 위치 재확인 버튼 -->
          <button
            type="button"
            id="locationBtn"
            onclick="recheckLocation()"
            class="w-full py-3.5 px-6 rounded-xl font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 border-2 border-indigo-200 dark:border-indigo-800 transition-all duration-200"
          >
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              위치 다시 확인하기
            </span>
          </button>
        </form>
      </div>

      <!-- QR 스캔 탭 -->
      <div id="qrTab" class="tab-content hidden">
        <div class="text-center mb-6">
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-full text-sm font-medium">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            관리자가 생성한 QR 코드를 스캔하세요
          </div>
        </div>

        <!-- QR 스캐너 -->
        <div id="qr-reader" class="mb-6 rounded-2xl overflow-hidden border-2 border-gray-200 dark:border-slate-600"></div>

        <!-- QR 스캔 결과 -->
        <div id="qrResult" class="hidden">
          <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-xl border-2 border-green-200 dark:border-green-800 mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div>
                <p class="font-semibold text-green-800 dark:text-green-400">QR 코드 인식 완료!</p>
                <p id="qrSessionInfo" class="text-sm text-green-600 dark:text-green-500"></p>
              </div>
            </div>
          </div>

          <!-- QR 스캔 후 이름/소속 입력 -->
          <form id="qrAttendanceForm" class="space-y-4">
            <div>
              <label for="qrName" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                성명 <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="qrName"
                placeholder="홍길동"
                maxlength="20"
                required
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 focus:border-indigo-500 focus:outline-none transition-all duration-200"
              >
            </div>
            <div>
              <label for="qrDepartment" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                소속 <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="qrDepartment"
                placeholder="경영학과, 교무팀 등"
                maxlength="50"
                required
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white placeholder-gray-400 focus:border-indigo-500 focus:outline-none transition-all duration-200"
              >
            </div>
            <button
              type="submit"
              id="qrSubmitBtn"
              class="w-full py-4 px-6 rounded-xl font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200"
            >
              QR 출석 체크하기
            </button>
          </form>
        </div>

        <!-- QR 스캔 버튼 -->
        <div id="qrControls" class="space-y-3">
          <button
            id="startScanBtn"
            onclick="startQRScanner()"
            class="w-full py-4 px-6 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200"
          >
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
              </svg>
              QR 코드 스캔 시작
            </span>
          </button>
          <button
            id="stopScanBtn"
            onclick="stopQRScanner()"
            class="w-full py-3 px-6 rounded-xl font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 hidden transition-all duration-200"
          >
            스캔 중지
          </button>
        </div>
      </div>

      <!-- 완료 메시지 -->
      <div id="completionMessage" class="hidden mt-6">
        <div class="text-center p-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl text-white">
          <div class="w-20 h-20 mx-auto mb-4 bg-white/20 rounded-full flex items-center justify-center animate-bounce-slow">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h3 class="text-2xl font-bold mb-2">출석 완료!</h3>
          <p id="completionDetails" class="text-green-100 whitespace-pre-line"></p>
        </div>
      </div>

      <!-- 로딩 오버레이 -->
      <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-4">
          <div class="spinner w-12 h-12 mx-auto mb-4"></div>
          <p id="loadingText" class="font-medium text-gray-700 dark:text-gray-300">처리중입니다...</p>
        </div>
      </div>
    </div>

    <!-- 푸터 -->
    <div class="text-center py-4 text-white/70 text-sm">
      <p>용인대학교 출석시스템 &copy; 2025</p>
      <p class="text-xs mt-1 text-white/50">PWA 지원 | QR + GPS 이중 인증</p>
    </div>
  </div>

  <script>
    // ========================================
    // 설정 및 전역 변수
    // ========================================

    const CONFIG = {
      BACKEND_URL: 'https://script.google.com/macros/s/AKfycbzYDZWn1OzOGiQ8OOeeepVhZjpMMfeoAfZ7AlFXg2w8yQWKSvEw9X7WQXxYaVF5RjTtAA/exec',
      DEFAULT_LOCATION: {
        latitude: 37.2420,
        longitude: 127.1775,
        radius: 1200
      },
      REQUEST_TIMEOUT: 30000,
      QR_TOKEN_PREFIX: 'YU_QR_'
    };

    let state = {
      isLocationValid: false,
      isSystemReady: false,
      isCompleted: false,
      isSubmitting: false,
      lastKnownPosition: null,
      locationSettings: { ...CONFIG.DEFAULT_LOCATION },
      deviceInfo: null,
      qrScanner: null,
      qrToken: null,
      currentTab: 'manual'
    };

    // ========================================
    // 초기화
    // ========================================

    document.addEventListener('DOMContentLoaded', function() {
      initializeSystem();
      initializeDarkMode();
      setupEventListeners();
      registerServiceWorker();
    });

    function initializeSystem() {
      console.log('시스템 초기화 시작');

      // 기기 정보 수집
      collectDeviceInfo();

      // 시스템 준비 완료
      state.isSystemReady = true;
      updateStatus('위치 확인이 필요합니다', 'checking');

      // 백그라운드에서 설정 로드
      setTimeout(loadSettingsFromServer, 500);

      // 자동 위치 확인
      setTimeout(startLocationCheck, 1500);

      console.log('시스템 초기화 완료');
    }

    function collectDeviceInfo() {
      state.deviceInfo = {
        userAgent: navigator.userAgent || 'unknown',
        platform: navigator.platform || 'unknown',
        language: navigator.language || 'ko',
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Seoul',
        screenInfo: `${screen.width}x${screen.height}x${screen.colorDepth || 24}`,
        touchPoints: navigator.maxTouchPoints || 0,
        timestamp: Date.now()
      };
    }

    function initializeDarkMode() {
      const isDark = localStorage.getItem('darkMode') === 'true' ||
                     (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);

      if (isDark) {
        document.documentElement.classList.add('dark');
      }
    }

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
    }

    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('Service Worker 등록 성공'))
          .catch(err => console.log('Service Worker 등록 실패:', err));
      }
    }

    // ========================================
    // 이벤트 리스너
    // ========================================

    function setupEventListeners() {
      // 폼 입력 검증
      ['name', 'department', 'email'].forEach(field => {
        const el = document.getElementById(field);
        if (el) {
          el.addEventListener('input', () => {
            validateField(field);
            validateForm();
          });
          el.addEventListener('blur', () => validateField(field));
        }
      });

      // 메인 폼 제출
      document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);

      // QR 폼 제출
      document.getElementById('qrAttendanceForm')?.addEventListener('submit', handleQRFormSubmit);
    }

    // ========================================
    // 탭 전환
    // ========================================

    function switchTab(tab) {
      state.currentTab = tab;

      // 탭 버튼 스타일
      const manualBtn = document.getElementById('tabManual');
      const qrBtn = document.getElementById('tabQR');

      if (tab === 'manual') {
        manualBtn.className = 'flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm';
        qrBtn.className = 'flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200';
        document.getElementById('manualTab').classList.remove('hidden');
        document.getElementById('qrTab').classList.add('hidden');
        stopQRScanner();
      } else {
        qrBtn.className = 'flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm';
        manualBtn.className = 'flex-1 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200';
        document.getElementById('qrTab').classList.remove('hidden');
        document.getElementById('manualTab').classList.add('hidden');
      }
    }

    // ========================================
    // 설정 로드
    // ========================================

    function loadSettingsFromServer() {
      callGoogleScript('getSettings', null)
        .then(result => {
          if (result && typeof result === 'object') {
            updateSettingsFromServer(result);
          }
        })
        .catch(err => console.log('설정 로드 실패, 기본값 사용'));
    }

    function updateSettingsFromServer(settings) {
      if (settings.meeting_title) {
        document.getElementById('meetingTitle').textContent = settings.meeting_title;
      }
      if (settings.meeting_description) {
        document.getElementById('meetingDescription').textContent = settings.meeting_description;
      }
      if (settings.target_latitude && settings.target_longitude) {
        state.locationSettings.latitude = parseFloat(settings.target_latitude);
        state.locationSettings.longitude = parseFloat(settings.target_longitude);
      }
      if (settings.location_radius) {
        state.locationSettings.radius = parseFloat(settings.location_radius);
      }
    }

    // ========================================
    // 위치 확인
    // ========================================

    function startLocationCheck() {
      if (!navigator.geolocation) {
        updateStatus('이 기기는 위치 확인을 지원하지 않습니다', 'error');
        return;
      }

      updateStatus('위치를 확인하고 있습니다...', 'checking');

      navigator.geolocation.getCurrentPosition(
        handleLocationSuccess,
        handleLocationError,
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 60000
        }
      );
    }

    function handleLocationSuccess(position) {
      state.lastKnownPosition = position;

      const { latitude: userLat, longitude: userLng, accuracy } = position.coords;
      const { latitude: targetLat, longitude: targetLng, radius } = state.locationSettings;

      const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
      const allowedRadius = calculateAllowedRadius(accuracy);

      console.log(`위치: ${userLat}, ${userLng}, 거리: ${distance}m, 허용: ${allowedRadius}m`);

      if (distance <= allowedRadius) {
        state.isLocationValid = true;

        let message = '위치 확인 완료';
        if (distance < 100) message += ' - 매우 가까움';
        else if (distance < 500) message += ` - 가까움 (${Math.round(distance)}m)`;
        else message += ` - 실내 환경 (${Math.round(distance)}m)`;

        updateStatus(message, 'ready');
        validateForm();

        if (distance > 800) {
          showToast('위치 확인 완료! 실내 GPS 오차를 고려하여 허용되었습니다.', 'success');
        }
      } else {
        state.isLocationValid = false;
        updateStatus(`회의실에서 ${Math.round(distance)}m 떨어져 있습니다`, 'error');
        showToast(`허용 거리(${allowedRadius}m)를 초과했습니다. 창가로 이동하거나 WiFi를 켜주세요.`, 'error');
        validateForm();
      }
    }

    function handleLocationError(error) {
      state.isLocationValid = false;

      let message = '위치 확인이 필요합니다';
      let toastMsg = '';

      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = '위치 권한이 필요합니다';
          toastMsg = '브라우저에서 위치 권한을 허용해주세요.';
          break;
        case error.POSITION_UNAVAILABLE:
          message = 'GPS 신호가 약합니다';
          toastMsg = '창가로 이동하거나 WiFi를 켜주세요.';
          break;
        case error.TIMEOUT:
          message = '위치 확인 시간 초과';
          toastMsg = '다시 시도해주세요.';
          break;
      }

      updateStatus(message, 'checking');
      if (toastMsg) showToast(toastMsg, 'warning');
      validateForm();
    }

    function recheckLocation() {
      const btn = document.getElementById('locationBtn');
      btn.disabled = true;
      btn.innerHTML = `
        <span class="flex items-center justify-center gap-2">
          <div class="spinner w-5 h-5"></div>
          위치 확인중...
        </span>
      `;

      updateStatus('위치를 다시 확인하고 있습니다...', 'checking');

      navigator.geolocation.getCurrentPosition(
        position => {
          btn.disabled = false;
          btn.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              위치 다시 확인하기
            </span>
          `;
          handleLocationSuccess(position);
          if (state.isLocationValid) showToast('위치 재확인 완료!', 'success');
        },
        error => {
          btn.disabled = false;
          btn.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              위치 다시 확인하기
            </span>
          `;
          handleLocationError(error);
        },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
      );
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;

      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) ** 2;

      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function calculateAllowedRadius(accuracy) {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      let multiplier = isMobile ? 1.2 : 1.8;

      if (accuracy > 500) multiplier *= 1.3;
      else if (accuracy > 200) multiplier *= 1.1;

      let radius = state.locationSettings.radius * multiplier;
      return Math.max(300, Math.min(2500, Math.round(radius)));
    }

    // ========================================
    // QR 스캐너
    // ========================================

    function startQRScanner() {
      if (state.qrScanner) {
        stopQRScanner();
      }

      document.getElementById('startScanBtn').classList.add('hidden');
      document.getElementById('stopScanBtn').classList.remove('hidden');
      document.getElementById('qrResult').classList.add('hidden');

      state.qrScanner = new Html5Qrcode('qr-reader');

      state.qrScanner.start(
        { facingMode: 'environment' },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        onQRCodeSuccess,
        onQRCodeError
      ).catch(err => {
        console.error('QR 스캐너 시작 실패:', err);
        showToast('카메라를 사용할 수 없습니다. 권한을 확인해주세요.', 'error');
        document.getElementById('startScanBtn').classList.remove('hidden');
        document.getElementById('stopScanBtn').classList.add('hidden');
      });
    }

    function stopQRScanner() {
      if (state.qrScanner) {
        state.qrScanner.stop().then(() => {
          state.qrScanner.clear();
          state.qrScanner = null;
        }).catch(console.error);
      }

      document.getElementById('startScanBtn').classList.remove('hidden');
      document.getElementById('stopScanBtn').classList.add('hidden');
    }

    function onQRCodeSuccess(decodedText) {
      console.log('QR 코드 인식:', decodedText);

      // QR 토큰 검증
      if (decodedText.startsWith(CONFIG.QR_TOKEN_PREFIX)) {
        stopQRScanner();
        state.qrToken = decodedText;

        // UI 업데이트
        document.getElementById('qrSessionInfo').textContent = `세션: ${decodedText.substring(0, 20)}...`;
        document.getElementById('qrResult').classList.remove('hidden');
        document.getElementById('qrControls').classList.add('hidden');

        showToast('QR 코드가 인식되었습니다! 정보를 입력해주세요.', 'success');

        // 위치 확인 시작
        if (!state.isLocationValid) {
          startLocationCheck();
        }
      } else {
        showToast('유효하지 않은 QR 코드입니다.', 'error');
      }
    }

    function onQRCodeError(error) {
      // 스캔 중 오류는 무시 (계속 스캔 시도)
    }

    // ========================================
    // 폼 검증
    // ========================================

    function validateField(fieldName) {
      const el = document.getElementById(fieldName);
      const validationEl = document.getElementById(`${fieldName}-validation`);
      if (!el) return true;

      const value = el.value.trim();
      let isValid = true;
      let message = '';

      if (fieldName === 'email') {
        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          isValid = false;
          message = '올바른 이메일 형식을 입력해주세요';
        }
      } else {
        if (!value) {
          isValid = false;
          message = '필수 항목입니다';
        } else if (value.length < 2) {
          isValid = false;
          message = '2자 이상 입력해주세요';
        }
      }

      if (validationEl) {
        if (isValid) {
          el.classList.remove('border-red-500');
          validationEl.classList.add('hidden');
        } else {
          el.classList.add('border-red-500');
          validationEl.textContent = message;
          validationEl.classList.remove('hidden');
        }
      }

      return isValid;
    }

    function validateForm() {
      if (state.isCompleted) return;

      const nameValid = validateField('name');
      const deptValid = validateField('department');
      const isFormValid = nameValid && deptValid && state.isLocationValid && state.isSystemReady;

      updateSubmitButton(isFormValid);
    }

    function updateSubmitButton(isValid) {
      const btn = document.getElementById('submitBtn');
      const textEl = document.getElementById('submitBtnText');

      if (state.isCompleted) {
        btn.disabled = true;
        textEl.textContent = '출석 완료됨';
      } else if (state.isSubmitting) {
        btn.disabled = true;
        textEl.textContent = '처리중...';
      } else if (!state.isSystemReady) {
        btn.disabled = true;
        textEl.textContent = '시스템 준비중...';
      } else if (!state.isLocationValid) {
        btn.disabled = true;
        textEl.textContent = '위치 확인 후 출석 체크';
      } else if (isValid) {
        btn.disabled = false;
        textEl.textContent = '출석 체크하기';
      } else {
        btn.disabled = true;
        textEl.textContent = '정보를 입력해주세요';
      }
    }

    // ========================================
    // 폼 제출
    // ========================================

    function handleFormSubmit(e) {
      e.preventDefault();

      if (state.isSubmitting || state.isCompleted || !state.isSystemReady || !state.isLocationValid) {
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        department: document.getElementById('department').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      submitAttendance(formData);
    }

    function handleQRFormSubmit(e) {
      e.preventDefault();

      if (!state.qrToken || state.isSubmitting) {
        showToast('QR 코드를 먼저 스캔해주세요.', 'warning');
        return;
      }

      if (!state.isLocationValid) {
        showToast('위치 확인이 필요합니다.', 'warning');
        startLocationCheck();
        return;
      }

      const formData = {
        name: document.getElementById('qrName').value.trim(),
        department: document.getElementById('qrDepartment').value.trim(),
        email: '',
        qrToken: state.qrToken
      };

      if (!formData.name || !formData.department) {
        showToast('성명과 소속을 입력해주세요.', 'warning');
        return;
      }

      submitAttendance(formData);
    }

    function submitAttendance(formData) {
      state.isSubmitting = true;
      updateSubmitButton(false);
      showLoading(true, '출석 정보를 전송하고 있습니다...');

      if (state.lastKnownPosition) {
        processSubmission(formData, state.lastKnownPosition);
      } else {
        navigator.geolocation.getCurrentPosition(
          position => processSubmission(formData, position),
          error => {
            state.isSubmitting = false;
            showLoading(false);
            showToast('위치 확인에 실패했습니다. 다시 시도해주세요.', 'error');
            updateSubmitButton(true);
          }
        );
      }
    }

    function processSubmission(formData, position) {
      const attendanceData = {
        ...formData,
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString(),
        ...state.deviceInfo
      };

      showLoading(true, '서버에 저장하고 있습니다...');

      callGoogleScript('saveAttendance', attendanceData)
        .then(result => {
          state.isSubmitting = false;
          showLoading(false);

          if (result && result.success) {
            completeAttendance(result);
          } else {
            const message = result?.error || result?.message || '출석 체크에 실패했습니다.';
            showToast(message, 'error');

            if (message.includes('위치') || message.includes('회의실')) {
              state.isLocationValid = false;
              updateStatus('위치를 다시 확인해주세요', 'checking');
            }

            updateSubmitButton(true);
          }
        })
        .catch(error => {
          state.isSubmitting = false;
          showLoading(false);
          showToast('출석 체크 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
          updateSubmitButton(true);
        });
    }

    function completeAttendance(result) {
      state.isCompleted = true;

      const details = [
        `출석자: ${document.getElementById('name')?.value || document.getElementById('qrName')?.value}`,
        `소속: ${document.getElementById('department')?.value || document.getElementById('qrDepartment')?.value}`,
        `시간: ${new Date().toLocaleString()}`,
        result.distance ? `거리: ${result.distance}m` : '',
        result.emailSent ? '\n확인 이메일이 발송되었습니다.' : ''
      ].filter(Boolean).join('\n');

      document.getElementById('completionDetails').textContent = details;
      document.getElementById('completionMessage').classList.remove('hidden');

      // 폼 숨기기
      document.getElementById('manualTab').classList.add('hidden');
      document.getElementById('qrTab').classList.add('hidden');

      updateSubmitButton(false);
      updateStatus('출석이 완료되었습니다!', 'ready');

      // 진동 피드백
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }

      // 완료 메시지로 스크롤
      document.getElementById('completionMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ========================================
    // Google Apps Script 통신 (JSONP)
    // ========================================

    function callGoogleScript(method, params) {
      return new Promise((resolve, reject) => {
        const callbackName = `gasCallback_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('요청 시간 초과'));
        }, CONFIG.REQUEST_TIMEOUT);

        function cleanup() {
          clearTimeout(timeoutId);
          delete window[callbackName];
          const script = document.getElementById(callbackName);
          if (script) script.remove();
        }

        window[callbackName] = result => {
          cleanup();
          resolve(result);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('네트워크 오류'));
        };

        let url = `${CONFIG.BACKEND_URL}?method=${encodeURIComponent(method)}&callback=${callbackName}`;
        if (params) {
          url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        }

        script.src = url;
        document.head.appendChild(script);
      });
    }

    // ========================================
    // UI 헬퍼
    // ========================================

    function updateStatus(message, type) {
      const indicator = document.getElementById('statusIndicator');
      if (!indicator) return;

      const colors = {
        ready: 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-700 dark:text-green-400',
        checking: 'bg-amber-100 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700 text-amber-700 dark:text-amber-400',
        error: 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-700 dark:text-red-400'
      };

      const icons = {
        ready: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>`,
        checking: `<div class="spinner w-5 h-5"></div>`,
        error: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>`
      };

      indicator.className = `mb-6 p-4 rounded-2xl border-2 transition-all duration-300 ${colors[type]}`;
      indicator.innerHTML = `
        <div class="flex items-center justify-center gap-3">
          ${icons[type]}
          <span class="font-medium">${message}</span>
        </div>
      `;
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      if (!container) return;

      const colors = {
        success: 'bg-green-50 dark:bg-green-900/50 border-green-200 dark:border-green-800 text-green-800 dark:text-green-300',
        error: 'bg-red-50 dark:bg-red-900/50 border-red-200 dark:border-red-800 text-red-800 dark:text-red-300',
        warning: 'bg-amber-50 dark:bg-amber-900/50 border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-300',
        info: 'bg-blue-50 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-300'
      };

      const toast = document.createElement('div');
      toast.className = `toast-enter p-4 rounded-xl border-2 mb-3 ${colors[type]}`;
      toast.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="flex-1 text-sm font-medium">${message}</div>
          <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 opacity-60 hover:opacity-100">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, type === 'success' ? 5000 : 8000);
    }

    function showLoading(show, text = '처리중입니다...') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');

      if (show) {
        loadingText.textContent = text;
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    console.log('용인대학교 출석 시스템 로드 완료 (현대적 UI, QR + GPS 이중 인증)');
  </script>
</body>
</html>

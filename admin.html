<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>용인대학교 출석 관리</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
              400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
              800: '#3730a3', 900: '#312e81'
            }
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Leaflet.js (지도) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B8DD6 100%);
    }
    .dark .gradient-bg {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e3a5f 100%);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }
    .dark .glass-card {
      background: rgba(30, 41, 59, 0.95);
    }
    .spinner {
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .fade-out { opacity: 0; transition: opacity 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #locationMap {
      height: 350px;
      width: 100%;
      border-radius: 1rem;
      z-index: 0;
    }
    .settings-tab-active {
      background: white;
      color: #4f46e5;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .dark .settings-tab-active {
      background: rgb(71 85 105);
      color: white;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen font-sans antialiased text-gray-900 dark:text-white transition-colors duration-300">

  <!-- 다크모드 토글 -->
  <button id="darkModeToggle" onclick="toggleDarkMode()" class="fixed top-4 right-4 z-50 p-3 rounded-full glass-card shadow-lg hover:scale-110 transition-transform">
    <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
    </svg>
    <svg id="moonIcon" class="w-6 h-6 text-indigo-600 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
      <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
    </svg>
  </button>

  <div class="container mx-auto px-4 py-6 max-w-6xl">

    <!-- 로그인 섹션 -->
    <div id="loginSection" class="max-w-md mx-auto fade-in">
      <div class="glass-card rounded-3xl shadow-2xl p-8">
        <div class="text-center mb-8">
          <img src="icons/logo-original.png" alt="용인대학교" class="w-20 h-20 mx-auto mb-4 object-contain">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">관리자 로그인</h1>
          <p class="text-gray-500 dark:text-gray-400 mt-2">용인대학교 출석시스템</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">비밀번호</label>
            <input type="password" id="adminPassword" placeholder="관리자 비밀번호" onkeypress="if(event.key==='Enter') login()"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <button onclick="login()" class="w-full py-3 px-6 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg transition-all">
            로그인
          </button>
          <div id="loginMessage" class="text-center"></div>
        </div>

        <div class="mt-6 p-4 bg-amber-50 dark:bg-amber-900/30 rounded-xl border border-amber-200 dark:border-amber-800">
          <p class="text-sm text-amber-700 dark:text-amber-400">
            <strong>기본 비밀번호:</strong> yongin2024<br>
            <span class="text-xs">보안 설정에서 변경 가능</span>
          </p>
        </div>
      </div>
    </div>

    <!-- 관리자 대시보드 -->
    <div id="adminDashboard" class="hidden">

      <!-- 헤더 -->
      <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6 fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">용인대학교 출석 관리</h1>
            <p id="lastUpdated" class="text-sm text-gray-500 dark:text-gray-400 mt-1">마지막 업데이트: -</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="refreshAll()" class="px-4 py-2 rounded-xl font-medium text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow transition-all">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                새로고침
              </span>
            </button>
            <button onclick="logout()" class="px-4 py-2 rounded-xl font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 border border-red-200 dark:border-red-800 transition-all">
              로그아웃
            </button>
          </div>
        </div>
      </div>

      <!-- 현재 회의 현황 요약 -->
      <div id="currentStatusCard" class="glass-card rounded-3xl shadow-2xl p-6 mb-6 fade-in border-2 border-indigo-200 dark:border-indigo-800">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          현재 회의 현황
        </h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <!-- 회의 정보 -->
          <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="text-sm font-semibold text-indigo-700 dark:text-indigo-300">회의 정보</span>
            </div>
            <div class="space-y-1">
              <p class="text-base font-bold text-gray-900 dark:text-white" id="statusMeetingTitle">-</p>
              <p class="text-sm text-gray-600 dark:text-gray-400" id="statusMeetingDesc">-</p>
              <div class="flex items-center gap-2 mt-2">
                <p class="text-xs text-gray-400 dark:text-gray-500">
                  이벤트 ID: <span id="statusEventId" class="font-mono">-</span>
                </p>
                <span id="statusModeBadge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">실외 GPS</span>
                <span id="statusProxyBadge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400">방지 OFF</span>
              </div>
            </div>
          </div>
          <!-- 위치 정보 -->
          <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-2xl">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span class="text-sm font-semibold text-emerald-700 dark:text-emerald-300">위치 정보</span>
            </div>
            <div class="space-y-1">
              <p class="text-sm text-gray-900 dark:text-white">
                <span class="font-medium" id="statusLatLng">-</span>
              </p>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                허용 반경: <span class="font-bold text-emerald-600 dark:text-emerald-400" id="statusRadius">-</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- 1. 회의 설정 (새 회의 + 회의 정보 + 보안 탭 통합) -->
      <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6 slide-up">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          회의 설정
        </h2>

        <!-- 설정 탭 -->
        <div class="flex bg-gray-100 dark:bg-slate-700 rounded-xl p-1 mb-6">
          <button id="settingsTabNewMeeting" onclick="switchMeetingSettingsTab('newMeeting')" class="flex-1 py-2 px-3 rounded-lg font-medium text-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm transition-all">
            새 회의
          </button>
          <button id="settingsTabMeeting" onclick="switchMeetingSettingsTab('meeting')" class="flex-1 py-2 px-3 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all">
            회의 정보
          </button>
          <button id="settingsTabSecurity" onclick="switchMeetingSettingsTab('security')" class="flex-1 py-2 px-3 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all">
            보안
          </button>
        </div>

        <!-- 새 회의 시작 -->
        <div id="newMeetingSettings" class="space-y-4">
          <p class="text-gray-600 dark:text-gray-400 text-sm">새 회의를 시작하면 모든 기기에서 다시 출석 체크가 가능합니다.</p>
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
              <input type="text" id="newMeetingTitle" placeholder="새 회의 제목 (선택사항)"
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
            </div>
            <button onclick="startNewMeeting()" id="newMeetingBtn" class="px-6 py-3 rounded-xl font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 shadow-lg transition-all whitespace-nowrap">
              새 회의 시작
            </button>
          </div>
          <div class="p-3 bg-gray-50 dark:bg-slate-800/50 rounded-xl">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              <strong>현재 이벤트 ID:</strong> <span id="currentEventId" class="font-mono">-</span>
            </p>
          </div>
        </div>

        <!-- 회의 정보 설정 -->
        <div id="meetingSettings" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">회의 제목</label>
            <input type="text" id="meetingTitle" placeholder="용인대학교 교직원 회의"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">회의 설명</label>
            <textarea id="meetingDescription" rows="3" placeholder="출석 정보를 정확히 입력해주세요"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all resize-none"></textarea>
          </div>
          <button onclick="saveMeetingSettings()" class="px-4 py-2 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow transition-all">
            저장
          </button>
        </div>

        <!-- 보안 설정 -->
        <div id="securitySettings" class="hidden space-y-4">
          <!-- 출석 모드 선택 (실내/실외) -->
          <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-200 dark:border-indigo-800">
            <p class="font-semibold text-gray-900 dark:text-white mb-3">출석 모드</p>
            <div class="grid grid-cols-2 gap-3">
              <label id="modeOutdoorLabel" class="relative cursor-pointer">
                <input type="radio" name="locationMode" value="outdoor" id="modeOutdoor" class="sr-only peer" checked>
                <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/30 transition-all text-center">
                  <svg class="w-8 h-8 mx-auto mb-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  <p class="font-bold text-sm text-gray-900 dark:text-white">실외 모드</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">GPS 위치 검증</p>
                </div>
              </label>
              <label id="modeIndoorLabel" class="relative cursor-pointer">
                <input type="radio" name="locationMode" value="indoor" id="modeIndoor" class="sr-only peer">
                <div class="p-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/30 transition-all text-center">
                  <svg class="w-8 h-8 mx-auto mb-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                  </svg>
                  <p class="font-bold text-sm text-gray-900 dark:text-white">실내 모드</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">QR 코드 검증</p>
                </div>
              </label>
            </div>
            <p class="text-xs text-indigo-600 dark:text-indigo-400 mt-2">실외: GPS 위치 필수 | 실내: QR 스캔 필수, GPS는 참고용</p>
          </div>

          <!-- 대리 출석 방지 토글 -->
          <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-slate-800/50 rounded-xl">
            <div>
              <p class="font-medium text-gray-900 dark:text-white">대리 출석 방지</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">같은 기기에서 중복 출석을 차단합니다 (테스트 시 OFF)</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer flex-shrink-0 ml-4">
              <input type="checkbox" id="preventProxyAttendance" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">새 비밀번호</label>
            <input type="password" id="newAdminPassword" placeholder="새 비밀번호 (6자 이상)"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">비밀번호 확인</label>
            <input type="password" id="confirmPassword" placeholder="비밀번호 다시 입력"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">알림 이메일</label>
            <input type="email" id="notificationEmail" placeholder="admin@example.com"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div class="flex gap-2">
            <button onclick="saveSecuritySettings()" class="px-4 py-2 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow transition-all">
              저장
            </button>
            <button onclick="testEmailSystem()" class="px-4 py-2 rounded-xl font-medium text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 hover:bg-amber-100 border border-amber-200 dark:border-amber-800 transition-all">
              이메일 테스트
            </button>
          </div>
        </div>

        <div id="settingsMessage" class="mt-4"></div>
      </div>

      <!-- 2. 위치 설정 (Leaflet 지도 포함) -->
      <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6 slide-up">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          위치 설정
        </h2>

        <!-- 지도 영역 -->
        <div id="locationMap" class="mb-4"></div>

        <!-- 좌표 및 반경 입력 -->
        <div class="grid sm:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">위도</label>
            <input type="number" id="targetLatitude" step="0.000001" placeholder="37.2420"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">경도</label>
            <input type="number" id="targetLongitude" step="0.000001" placeholder="127.1775"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">허용 반경 (m)</label>
            <input type="number" id="locationRadius" min="100" max="5000" placeholder="1200"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:border-indigo-500 focus:outline-none transition-all">
          </div>
        </div>

        <div class="flex gap-2">
          <button onclick="getCurrentLocation()" class="px-4 py-2 rounded-xl font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 border border-indigo-200 dark:border-indigo-800 transition-all flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06z"/>
            </svg>
            현재 위치 사용
          </button>
          <button onclick="saveLocationSettings()" class="px-4 py-2 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow transition-all">
            저장
          </button>
        </div>

        <div id="locationSettingsMessage" class="mt-4"></div>
      </div>

      <!-- 3. QR 코드 생성 -->
      <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6 slide-up">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
          </svg>
          QR 코드 생성
        </h2>

        <div class="text-center">
          <div id="qrCodeContainer" class="bg-white p-6 rounded-2xl inline-block mb-4 shadow-inner">
            <div id="qrCodeArea" class="w-[200px] h-[200px] flex items-center justify-center text-gray-400 text-sm">
              QR 코드 생성 대기중
            </div>
          </div>

          <div id="qrTokenInfo" class="mb-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">새 회의를 시작하면 QR 코드가 자동 생성됩니다</p>
          </div>

          <div class="flex gap-2 justify-center">
            <button onclick="generateQRCode()" class="px-6 py-3 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-lg transition-all">
              QR 코드 표시
            </button>
            <button onclick="downloadQRCode()" class="px-4 py-3 rounded-xl font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 border border-indigo-200 dark:border-indigo-800 transition-all">
              다운로드
            </button>
          </div>
        </div>
      </div>

      <!-- 4. 통계 카드 -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="glass-card rounded-2xl p-6 shadow-lg slide-up cursor-pointer hover:scale-105 transition-transform" onclick="refreshStats()">
          <div class="text-4xl font-bold text-indigo-600 dark:text-indigo-400" id="totalAttendees">-</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">현재 출석자</div>
        </div>
        <div class="glass-card rounded-2xl p-6 shadow-lg slide-up cursor-pointer hover:scale-105 transition-transform" onclick="refreshStats()">
          <div class="text-4xl font-bold text-green-600 dark:text-green-400" id="currentEventAttendees">-</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">현재 회의</div>
        </div>
        <div class="glass-card rounded-2xl p-6 shadow-lg slide-up cursor-pointer hover:scale-105 transition-transform" onclick="refreshStats()">
          <div class="text-4xl font-bold text-red-600 dark:text-red-400" id="deviceBlocked">-</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">차단 기록</div>
        </div>
        <div class="glass-card rounded-2xl p-6 shadow-lg slide-up cursor-pointer hover:scale-105 transition-transform" onclick="refreshStats()">
          <div class="text-4xl font-bold text-blue-600 dark:text-blue-400" id="emailsSent">-</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">이메일 발송</div>
        </div>
      </div>

      <!-- 5. 출석 차트 + 출석자 목록 (2열) -->
      <div class="grid lg:grid-cols-2 gap-6 mb-6">

        <!-- 출석 차트 -->
        <div class="glass-card rounded-3xl shadow-2xl p-6 slide-up">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
            </svg>
            출석 통계
          </h2>
          <div class="h-64">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>

        <!-- 출석자 목록 & 다운로드 -->
        <div class="glass-card rounded-3xl shadow-2xl p-6 slide-up">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
              출석자 목록
            </h2>

            <div class="flex gap-2">
              <button onclick="downloadExcel()" class="px-4 py-2 rounded-xl font-medium text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/30 hover:bg-green-100 border border-green-200 dark:border-green-800 transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Excel
              </button>
              <button onclick="downloadCSV()" class="px-4 py-2 rounded-xl font-medium text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 border border-blue-200 dark:border-blue-800 transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                CSV
              </button>
            </div>
          </div>

          <!-- 탭 -->
          <div class="flex bg-gray-100 dark:bg-slate-700 rounded-xl p-1 mb-4">
            <button id="tabRecent" onclick="switchAttendanceTab('recent')" class="flex-1 py-2 px-4 rounded-lg font-medium text-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm transition-all">
              최근 출석자
            </button>
            <button id="tabBlocked" onclick="switchAttendanceTab('blocked')" class="flex-1 py-2 px-4 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all">
              차단 기록
            </button>
          </div>

          <!-- 출석자 목록 -->
          <div id="recentAttendeesTab" class="max-h-96 overflow-y-auto space-y-3">
            <div class="text-center py-8 text-gray-400">
              <div class="spinner w-8 h-8 mx-auto mb-2"></div>
              출석자 정보를 불러오는 중...
            </div>
          </div>

          <!-- 차단 목록 -->
          <div id="blockedTab" class="hidden max-h-96 overflow-y-auto space-y-3">
            <div class="text-center py-8 text-gray-400">
              차단 기록이 없습니다
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 토스트 컨테이너 -->
  <div id="toastContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

  <script>
    // ========================================
    // 설정 및 상태
    // ========================================

    const CONFIG = {
      BACKEND_URL: 'https://script.google.com/macros/s/AKfycbwellkib5OLAZl3q7Nzr_SG2_rLvrvKMUQQ-_whl_xmjwP3oEN8loIxvWcXXjbhU06KBw/exec',
      QR_TOKEN_PREFIX: 'YU_QR_',
      QR_VALIDITY_MINUTES: 15,
      REFRESH_INTERVAL: 180000 // 3분
    };

    let state = {
      isLoggedIn: false,
      refreshInterval: null,
      currentQRToken: null,
      attendanceChart: null,
      qrInstance: null,
      attendanceData: [],
      blockedData: [],
      settings: {},
      map: null,
      mapMarker: null,
      mapCircle: null
    };

    // ========================================
    // 초기화
    // ========================================

    document.addEventListener('DOMContentLoaded', function() {
      initializeDarkMode();
      document.getElementById('adminPassword').focus();
    });

    function initializeDarkMode() {
      const isDark = localStorage.getItem('darkMode') === 'true' ||
                     (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (isDark) document.documentElement.classList.add('dark');
    }

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      if (state.attendanceChart) updateChart();
    }

    // ========================================
    // 로그인
    // ========================================

    function login() {
      const password = document.getElementById('adminPassword').value.trim();
      if (!password) {
        showMessage('loginMessage', '비밀번호를 입력해주세요.', 'error');
        return;
      }

      showMessage('loginMessage', '로그인 중...', 'info');

      // Google Apps Script 인증 시도
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => result ? loginSuccess() : loginFailure())
          .withFailureHandler(() => tryFallbackLogin(password))
          .authenticateAdmin(password);
      } else {
        tryFallbackLogin(password);
      }
    }

    function tryFallbackLogin(password) {
      // 서버 API를 통해 인증 (변경된 비밀번호 반영)
      callGoogleScript('authenticateAdmin', { password: password })
        .then(result => {
          if (result && result.authenticated) {
            loginSuccess();
          } else {
            loginFailure();
          }
        })
        .catch(() => {
          // 서버 연결 실패 시 기본 비밀번호로 폴백
          if (password === 'yongin2024') {
            loginSuccess();
          } else {
            loginFailure();
          }
        });
    }

    function loginSuccess() {
      state.isLoggedIn = true;
      showMessage('loginMessage', '로그인 성공!', 'success');

      setTimeout(() => {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        initializeDashboard();
      }, 500);
    }

    function loginFailure() {
      showMessage('loginMessage', '잘못된 비밀번호입니다.', 'error');
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }

    function logout() {
      if (!confirm('로그아웃 하시겠습니까?')) return;

      state.isLoggedIn = false;
      if (state.refreshInterval) clearInterval(state.refreshInterval);

      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('adminPassword').value = '';
      document.getElementById('loginMessage').innerHTML = '';

      setTimeout(() => document.getElementById('adminPassword').focus(), 300);
    }

    // ========================================
    // 대시보드 초기화
    // ========================================

    function initializeDashboard() {
      updateLastUpdated();
      loadCurrentSettings();
      refreshAll();
      initializeChart();
      initMap();
      generateQRCode();

      state.refreshInterval = setInterval(() => {
        if (state.isLoggedIn) {
          refreshStats();
          updateLastUpdated();
        }
      }, CONFIG.REFRESH_INTERVAL);
    }

    function updateLastUpdated() {
      document.getElementById('lastUpdated').textContent = '마지막 업데이트: ' + new Date().toLocaleString();
    }

    function refreshAll() {
      if (!state.isLoggedIn) return;
      refreshStats();
      refreshSystemStatus();
      updateLastUpdated();
    }

    // ========================================
    // 통계 조회
    // ========================================

    function refreshStats() {
      if (!state.isLoggedIn) return;

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(handleStatsResult)
          .withFailureHandler(() => setDefaultStats())
          .getAttendanceStats();
      } else {
        // JSONP fallback
        callGoogleScript('getAttendanceStats', null)
          .then(handleStatsResult)
          .catch(() => setDefaultStats());
      }
    }

    function handleStatsResult(result) {
      if (result && result.success && result.stats) {
        updateStatsDisplay(result.stats);
        state.attendanceData = result.stats.recentAttendees || [];
        state.blockedData = result.stats.blockedDevices || [];
        updateRecentAttendees(state.attendanceData);
        updateBlockedDevices(state.blockedData);
        updateChart();
      } else {
        setDefaultStats();
      }
    }

    function updateStatsDisplay(stats) {
      document.getElementById('totalAttendees').textContent = stats.totalAttendees || 0;
      document.getElementById('currentEventAttendees').textContent = stats.currentEventAttendees || 0;
      document.getElementById('deviceBlocked').textContent = stats.deviceBlocked || 0;
      document.getElementById('emailsSent').textContent = stats.emailsSent || 0;
    }

    function setDefaultStats() {
      document.getElementById('totalAttendees').textContent = '-';
      document.getElementById('currentEventAttendees').textContent = '-';
      document.getElementById('deviceBlocked').textContent = '-';
      document.getElementById('emailsSent').textContent = '-';
    }

    function refreshSystemStatus() {
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              document.getElementById('currentEventId').textContent = result.currentEventId || 'N/A';
              document.getElementById('statusEventId').textContent = result.currentEventId || 'N/A';
            }
          })
          .withFailureHandler(() => {})
          .getSystemStatus();
      } else {
        callGoogleScript('getSystemStatus', null)
          .then(result => {
            if (result && result.success) {
              document.getElementById('currentEventId').textContent = result.currentEventId || 'N/A';
              document.getElementById('statusEventId').textContent = result.currentEventId || 'N/A';
            }
          })
          .catch(() => {});
      }
    }

    // ========================================
    // 출석자 목록
    // ========================================

    function updateRecentAttendees(attendees) {
      const container = document.getElementById('recentAttendeesTab');

      if (!attendees || attendees.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            아직 출석자가 없습니다
          </div>
        `;
        return;
      }

      container.innerHTML = attendees.map((a, i) => `
        <div class="p-4 bg-gray-50 dark:bg-slate-700/50 rounded-xl border-l-4 border-indigo-500">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-bold text-gray-900 dark:text-white">${i + 1}. ${a.name || '이름 없음'}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                ${a.department || '소속 없음'} · ${a.email || '(이메일 없음)'}
              </div>
            </div>
            <div class="text-right">
              <div class="text-xs text-gray-400">${a.time || ''}</div>
              <div class="text-xs text-indigo-600 dark:text-indigo-400">${a.distance ? a.distance + 'm' : ''}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateBlockedDevices(blocked) {
      const container = document.getElementById('blockedTab');

      if (!blocked || blocked.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
            </svg>
            차단 기록이 없습니다
          </div>
        `;
        return;
      }

      container.innerHTML = blocked.map((b, i) => `
        <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border-l-4 border-red-500">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-bold text-red-800 dark:text-red-400">${i + 1}. ${b.name || '이름 없음'}</div>
              <div class="text-sm text-red-600 dark:text-red-500 mt-1">
                ${b.department || '소속 없음'} · ${b.reason || ''}
              </div>
            </div>
            <div class="text-xs text-gray-400">${b.time || ''}</div>
          </div>
        </div>
      `).join('');
    }

    function switchAttendanceTab(tab) {
      const recentBtn = document.getElementById('tabRecent');
      const blockedBtn = document.getElementById('tabBlocked');
      const recentTab = document.getElementById('recentAttendeesTab');
      const blockedTab = document.getElementById('blockedTab');

      if (tab === 'recent') {
        recentBtn.className = 'flex-1 py-2 px-4 rounded-lg font-medium text-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm transition-all';
        blockedBtn.className = 'flex-1 py-2 px-4 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all';
        recentTab.classList.remove('hidden');
        blockedTab.classList.add('hidden');
      } else {
        blockedBtn.className = 'flex-1 py-2 px-4 rounded-lg font-medium text-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm transition-all';
        recentBtn.className = 'flex-1 py-2 px-4 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all';
        blockedTab.classList.remove('hidden');
        recentTab.classList.add('hidden');
      }
    }

    // ========================================
    // QR 코드 생성
    // ========================================

    function generateQRCode() {
      // 출석 페이지 URL 기반 QR 코드 생성 (회의 종료까지 유지)
      const attendanceUrl = window.location.href.replace(/\/admin\.html.*$/, '/index.html');

      const qrArea = document.getElementById('qrCodeArea');
      qrArea.innerHTML = '';

      try {
        state.qrInstance = new QRCode(qrArea, {
          text: attendanceUrl,
          width: 200,
          height: 200,
          colorDark: '#1e1b4b',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (error) {
        console.error('QR 코드 생성 실패:', error);
        showToast('QR 코드 생성에 실패했습니다.', 'error');
        return;
      }

      state.currentQRToken = attendanceUrl;

      const meetingTitle = document.getElementById('meetingTitle')?.value ||
                           state.settings.meeting_title || '회의';

      document.getElementById('qrTokenInfo').innerHTML = `
        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${meetingTitle}</p>
        <p class="text-xs text-gray-400 mt-1">이 QR 코드를 스캔하면 출석 페이지로 이동합니다</p>
        <p class="text-xs text-indigo-500 dark:text-indigo-400 mt-1">새 회의를 시작할 때까지 유지됩니다</p>
      `;

      showToast('QR 코드가 생성되었습니다!', 'success');
    }

    function downloadQRCode() {
      if (!state.currentQRToken) {
        showToast('먼저 QR 코드를 생성해주세요.', 'warning');
        return;
      }

      const qrArea = document.getElementById('qrCodeArea');
      const canvas = qrArea.querySelector('canvas');
      const img = qrArea.querySelector('img');
      const link = document.createElement('a');
      link.download = `yiu-attendance-qr-${Date.now()}.png`;

      if (canvas) {
        link.href = canvas.toDataURL();
      } else if (img) {
        link.href = img.src;
      } else {
        showToast('QR 코드를 찾을 수 없습니다.', 'error');
        return;
      }

      link.click();
      showToast('QR 코드가 다운로드되었습니다.', 'success');
    }

    // ========================================
    // 차트
    // ========================================

    function initializeChart() {
      const ctx = document.getElementById('attendanceChart').getContext('2d');
      const isDark = document.documentElement.classList.contains('dark');

      state.attendanceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['현재 회의 출석', '차단'],
          datasets: [{
            data: [0, 0],
            backgroundColor: ['#10b981', '#ef4444'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: isDark ? '#e5e7eb' : '#374151',
                font: { size: 12 }
              }
            }
          }
        }
      });
    }

    function updateChart() {
      if (!state.attendanceChart) return;

      const isDark = document.documentElement.classList.contains('dark');
      const currentAttendees = parseInt(document.getElementById('currentEventAttendees').textContent) || 0;
      const blocked = parseInt(document.getElementById('deviceBlocked').textContent) || 0;

      state.attendanceChart.data.datasets[0].data = [
        currentAttendees,
        blocked
      ];

      state.attendanceChart.options.plugins.legend.labels.color = isDark ? '#e5e7eb' : '#374151';
      state.attendanceChart.update();
    }

    // ========================================
    // 다운로드 기능
    // ========================================

    function downloadExcel() {
      if (state.attendanceData.length === 0) {
        showToast('다운로드할 데이터가 없습니다.', 'warning');
        return;
      }

      const data = state.attendanceData.map((a, i) => ({
        '번호': i + 1,
        '성명': a.name || '',
        '소속': a.department || '',
        '이메일': a.email || '',
        '출석시간': a.time || '',
        '거리(m)': a.distance || ''
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '출석자목록');

      XLSX.writeFile(wb, `출석자목록_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Excel 파일이 다운로드되었습니다.', 'success');
    }

    function downloadCSV() {
      if (state.attendanceData.length === 0) {
        showToast('다운로드할 데이터가 없습니다.', 'warning');
        return;
      }

      const headers = ['번호', '성명', '소속', '이메일', '출석시간', '거리(m)'];
      const rows = state.attendanceData.map((a, i) => [
        i + 1,
        a.name || '',
        a.department || '',
        a.email || '',
        a.time || '',
        a.distance || ''
      ]);

      const csv = [headers, ...rows].map(row =>
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `출석자목록_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      showToast('CSV 파일이 다운로드되었습니다.', 'success');
    }

    // ========================================
    // 새 회의 시작
    // ========================================

    function startNewMeeting() {
      const title = document.getElementById('newMeetingTitle').value.trim();

      if (!confirm('새 회의를 시작하시겠습니까?\n\n모든 기기에서 다시 출석 체크가 가능합니다.')) {
        return;
      }

      const btn = document.getElementById('newMeetingBtn');
      btn.disabled = true;
      btn.textContent = '시작 중...';

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(handleNewMeetingResult)
          .withFailureHandler(err => handleNewMeetingError(err))
          .startNewMeetingFixed(title);
      } else {
        callGoogleScript('startNewMeeting', { meetingTitle: title })
          .then(handleNewMeetingResult)
          .catch(handleNewMeetingError);
      }
    }

    function handleNewMeetingResult(result) {
      const btn = document.getElementById('newMeetingBtn');
      btn.disabled = false;
      btn.textContent = '새 회의 시작';

      if (result && result.success) {
        showToast('새 회의가 시작되었습니다!', 'success');
        document.getElementById('currentEventId').textContent = result.eventId || '생성됨';

        // 새 회의 제목이 있으면 settings에도 반영
        const newTitle = document.getElementById('newMeetingTitle').value.trim();
        if (newTitle) {
          state.settings.meeting_title = newTitle;
          document.getElementById('meetingTitle').value = newTitle;
        }

        document.getElementById('newMeetingTitle').value = '';
        updateCurrentStatus();
        generateQRCode();
        setTimeout(refreshAll, 1000);
      } else {
        showToast(result?.error || '새 회의 시작에 실패했습니다.', 'error');
      }
    }

    function handleNewMeetingError(err) {
      const btn = document.getElementById('newMeetingBtn');
      btn.disabled = false;
      btn.textContent = '새 회의 시작';
      showToast('새 회의 시작 중 오류가 발생했습니다.', 'error');
    }

    // ========================================
    // 설정
    // ========================================

    function loadCurrentSettings() {
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(updateSettingsUI)
          .withFailureHandler(() => updateSettingsUI({}))
          .getSettings();
      } else {
        callGoogleScript('getSettings', null)
          .then(updateSettingsUI)
          .catch(() => updateSettingsUI({}));
      }
    }

    function updateSettingsUI(settings) {
      settings = settings || {};
      state.settings = settings;

      const lat = parseFloat(settings.target_latitude) || 37.2420;
      const lng = parseFloat(settings.target_longitude) || 127.1775;
      const radius = parseInt(settings.location_radius) || 1200;

      document.getElementById('targetLatitude').value = lat;
      document.getElementById('targetLongitude').value = lng;
      document.getElementById('locationRadius').value = radius;
      document.getElementById('meetingTitle').value = settings.meeting_title || '용인대학교 교직원 회의';
      document.getElementById('meetingDescription').value = settings.meeting_description || '출석 정보를 정확히 입력해주세요';
      document.getElementById('notificationEmail').value = settings.notification_email || '';

      const preventProxyEl = document.getElementById('preventProxyAttendance');
      if (preventProxyEl) {
        preventProxyEl.checked = settings.prevent_proxy_attendance === true || settings.prevent_proxy_attendance === 'true';
      }

      // 출석 모드 반영
      const locationMode = settings.location_mode || 'outdoor';
      const modeRadio = document.getElementById(locationMode === 'indoor' ? 'modeIndoor' : 'modeOutdoor');
      if (modeRadio) modeRadio.checked = true;

      // 지도가 이미 초기화되어 있으면 업데이트
      if (state.map) {
        state.map.setView([lat, lng], 16);
        updateMapMarker(lat, lng);
        if (state.mapCircle) {
          state.mapCircle.setRadius(radius);
        }
      }

      // 현재 회의 현황 요약 갱신
      updateCurrentStatus();
    }

    function switchMeetingSettingsTab(tab) {
      const tabMap = {
        newMeeting: { btnId: 'settingsTabNewMeeting', contentId: 'newMeetingSettings' },
        meeting: { btnId: 'settingsTabMeeting', contentId: 'meetingSettings' },
        security: { btnId: 'settingsTabSecurity', contentId: 'securitySettings' }
      };

      Object.keys(tabMap).forEach(t => {
        const btn = document.getElementById(tabMap[t].btnId);
        const content = document.getElementById(tabMap[t].contentId);

        if (t === tab) {
          btn.className = 'flex-1 py-2 px-3 rounded-lg font-medium text-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-white shadow-sm transition-all';
          content.classList.remove('hidden');
        } else {
          btn.className = 'flex-1 py-2 px-3 rounded-lg font-medium text-sm text-gray-500 dark:text-gray-400 transition-all';
          content.classList.add('hidden');
        }
      });
    }

    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showLocationMessage('위치 서비스가 지원되지 않습니다.', 'error');
        return;
      }

      showLocationMessage('현재 위치 확인 중...', 'info');

      navigator.geolocation.getCurrentPosition(
        position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          document.getElementById('targetLatitude').value = lat.toFixed(6);
          document.getElementById('targetLongitude').value = lng.toFixed(6);

          const accuracy = position.coords.accuracy;
          let radius = 1200;
          if (accuracy > 500) radius = 2000;
          else if (accuracy > 200) radius = 1500;
          else if (accuracy > 100) radius = 1000;

          document.getElementById('locationRadius').value = radius;

          // 지도 업데이트
          updateMapMarker(lat, lng);
          if (state.map) {
            state.map.setView([lat, lng], 16);
          }

          showLocationMessage(`위치 설정 완료! (정확도: ${Math.round(accuracy)}m)`, 'success');
        },
        error => {
          showLocationMessage('위치 확인에 실패했습니다.', 'error');
        },
        { enableHighAccuracy: true, timeout: 15000 }
      );
    }

    function showLocationMessage(message, type) {
      showMessage('locationSettingsMessage', message, type);
    }

    function saveLocationSettings() {
      const settings = {
        ...state.settings,
        target_latitude: document.getElementById('targetLatitude').value,
        target_longitude: document.getElementById('targetLongitude').value,
        location_radius: document.getElementById('locationRadius').value
      };
      saveSettings(settings, 'locationSettingsMessage');
    }

    function saveMeetingSettings() {
      const settings = {
        ...state.settings,
        meeting_title: document.getElementById('meetingTitle').value,
        meeting_description: document.getElementById('meetingDescription').value
      };
      saveSettings(settings);
    }

    function saveSecuritySettings() {
      const newPassword = document.getElementById('newAdminPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword && newPassword !== confirmPassword) {
        showSettingsMessage('비밀번호가 일치하지 않습니다.', 'error');
        return;
      }

      if (newPassword && newPassword.length < 6) {
        showSettingsMessage('비밀번호는 6자 이상이어야 합니다.', 'error');
        return;
      }

      const locationMode = document.querySelector('input[name="locationMode"]:checked').value;

      const settings = {
        ...state.settings,
        notification_email: document.getElementById('notificationEmail').value,
        prevent_proxy_attendance: document.getElementById('preventProxyAttendance').checked,
        location_mode: locationMode
      };

      if (newPassword) {
        settings.admin_password = newPassword;
      }

      saveSettings(settings);

      // 비밀번호 필드 초기화
      document.getElementById('newAdminPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    function saveSettings(settings, messageContainerId) {
      const msgId = messageContainerId || 'settingsMessage';
      const showMsg = (msg, type) => showMessage(msgId, msg, type);

      showMsg('저장 중...', 'info');

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              state.settings = settings;
              showMsg('설정이 저장되었습니다!', 'success');
              updateCurrentStatus();
            } else {
              showMsg('설정 저장에 실패했습니다.', 'error');
            }
          })
          .withFailureHandler(() => showMsg('설정 저장 중 오류가 발생했습니다.', 'error'))
          .saveSettings(settings);
      } else {
        callGoogleScript('saveSettings', { settings })
          .then(result => {
            if (result && result.success) {
              state.settings = settings;
              showMsg('설정이 저장되었습니다!', 'success');
              updateCurrentStatus();
            } else {
              showMsg('설정 저장에 실패했습니다.', 'error');
            }
          })
          .catch(() => showMsg('설정 저장 중 오류가 발생했습니다.', 'error'));
      }
    }

    function testEmailSystem() {
      showSettingsMessage('테스트 이메일 발송 중...', 'info');

      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              showSettingsMessage('테스트 이메일이 발송되었습니다!', 'success');
            } else {
              showSettingsMessage(result?.error || '이메일 테스트에 실패했습니다.', 'error');
            }
          })
          .withFailureHandler(() => showSettingsMessage('이메일 테스트 중 오류가 발생했습니다.', 'error'))
          .testEmailSystem();
      } else {
        callGoogleScript('testEmailSystem', null)
          .then(result => {
            if (result && result.success) {
              showSettingsMessage('테스트 이메일이 발송되었습니다!', 'success');
            } else {
              showSettingsMessage(result?.error || '이메일 테스트에 실패했습니다.', 'error');
            }
          })
          .catch(() => showSettingsMessage('이메일 테스트 중 오류가 발생했습니다.', 'error'));
      }
    }

    function showSettingsMessage(message, type) {
      showMessage('settingsMessage', message, type);
    }

    // ========================================
    // 현재 회의 현황 요약
    // ========================================

    function updateCurrentStatus() {
      const s = state.settings;

      // 회의 정보
      const title = s.meeting_title || '용인대학교 교직원 회의';
      const desc = s.meeting_description || '출석 정보를 정확히 입력해주세요';
      document.getElementById('statusMeetingTitle').textContent = title;
      document.getElementById('statusMeetingDesc').textContent = desc;

      // 이벤트 ID (currentEventId 요소에서 가져오기)
      const eventId = document.getElementById('currentEventId').textContent;
      document.getElementById('statusEventId').textContent = eventId || '-';

      // 위치 정보
      const lat = parseFloat(s.target_latitude) || 37.2420;
      const lng = parseFloat(s.target_longitude) || 127.1775;
      const radius = parseInt(s.location_radius) || 1200;
      document.getElementById('statusLatLng').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      document.getElementById('statusRadius').textContent = `${radius}m`;

      // 출석 모드 상태
      const locationMode = s.location_mode || 'outdoor';
      const modeBadge = document.getElementById('statusModeBadge');
      if (modeBadge) {
        if (locationMode === 'indoor') {
          modeBadge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400';
          modeBadge.textContent = '실내 QR';
        } else {
          modeBadge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
          modeBadge.textContent = '실외 GPS';
        }
      }

      // 대리 출석 방지 상태
      const proxyEnabled = s.prevent_proxy_attendance === true || s.prevent_proxy_attendance === 'true';
      const badge = document.getElementById('statusProxyBadge');
      if (badge) {
        if (proxyEnabled) {
          badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
          badge.textContent = '중복방지 ON';
        } else {
          badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400';
          badge.textContent = '중복방지 OFF';
        }
      }
    }

    // ========================================
    // Leaflet 지도
    // ========================================

    function initMap() {
      const lat = parseFloat(document.getElementById('targetLatitude').value) || 37.2420;
      const lng = parseFloat(document.getElementById('targetLongitude').value) || 127.1775;
      const radius = parseInt(document.getElementById('locationRadius').value) || 1200;

      state.map = L.map('locationMap').setView([lat, lng], 16);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(state.map);

      // 마커 및 반경 원 생성
      state.mapMarker = L.marker([lat, lng], { draggable: true }).addTo(state.map);
      state.mapCircle = L.circle([lat, lng], {
        radius: radius,
        color: '#4f46e5',
        fillColor: '#6366f1',
        fillOpacity: 0.15,
        weight: 2
      }).addTo(state.map);

      // 마커 드래그 시 좌표 갱신
      state.mapMarker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        document.getElementById('targetLatitude').value = pos.lat.toFixed(6);
        document.getElementById('targetLongitude').value = pos.lng.toFixed(6);
        state.mapCircle.setLatLng(pos);
      });

      // 지도 클릭 이벤트
      state.map.on('click', onMapClick);

      // 반경 input 변경 시 원 크기 실시간 반영
      document.getElementById('locationRadius').addEventListener('input', function() {
        const newRadius = parseInt(this.value) || 1200;
        if (state.mapCircle) {
          state.mapCircle.setRadius(newRadius);
        }
      });

      // 위도/경도 input 변경 시 지도 갱신
      document.getElementById('targetLatitude').addEventListener('change', function() {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('targetLongitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          updateMapMarker(lat, lng);
        }
      });

      document.getElementById('targetLongitude').addEventListener('change', function() {
        const lat = parseFloat(document.getElementById('targetLatitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
          updateMapMarker(lat, lng);
        }
      });
    }

    function updateMapMarker(lat, lng) {
      if (state.mapMarker) {
        state.mapMarker.setLatLng([lat, lng]);
      }
      if (state.mapCircle) {
        state.mapCircle.setLatLng([lat, lng]);
      }
    }

    function onMapClick(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      document.getElementById('targetLatitude').value = lat.toFixed(6);
      document.getElementById('targetLongitude').value = lng.toFixed(6);

      updateMapMarker(lat, lng);
    }

    // ========================================
    // Google Apps Script 통신 (JSONP)
    // ========================================

    function callGoogleScript(method, params) {
      return new Promise((resolve, reject) => {
        const callbackName = `gasCallback_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('요청 시간 초과'));
        }, 30000);

        function cleanup() {
          clearTimeout(timeoutId);
          delete window[callbackName];
          const script = document.getElementById(callbackName);
          if (script) script.remove();
        }

        window[callbackName] = result => {
          cleanup();
          resolve(result);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('네트워크 오류'));
        };

        let url = `${CONFIG.BACKEND_URL}?method=${encodeURIComponent(method)}&callback=${callbackName}`;
        if (params) {
          url += `&params=${encodeURIComponent(JSON.stringify(params))}`;
        }

        script.src = url;
        document.head.appendChild(script);
      });
    }

    // ========================================
    // UI 헬퍼
    // ========================================

    function showMessage(containerId, message, type) {
      const container = document.getElementById(containerId);
      const colors = {
        success: 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800',
        error: 'bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800',
        info: 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800'
      };

      container.innerHTML = `
        <div class="p-3 rounded-xl border ${colors[type]} text-sm font-medium fade-in">
          ${message}
        </div>
      `;

      if (type === 'success') {
        setTimeout(() => container.innerHTML = '', 3000);
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-amber-500',
        info: 'bg-blue-500'
      };

      const toast = document.createElement('div');
      toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg fade-in flex items-center gap-3 max-w-sm`;
      toast.innerHTML = `
        <span class="flex-1 text-sm font-medium">${message}</span>
        <button onclick="this.parentElement.remove()" class="opacity-70 hover:opacity-100">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
      }, type === 'success' ? 3000 : 5000);
    }

    console.log('용인대학교 출석 관리 시스템 로드 완료');

    // Service Worker 등록
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('[SW] 등록 완료:', reg.scope))
        .catch(err => console.error('[SW] 등록 실패:', err));
    }
  </script>
</body>
</html>

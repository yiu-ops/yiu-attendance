<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜ ê´€ë¦¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "ë§‘ì€ ê³ ë”•", "Malgun Gothic", Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      line-height: 1.6;
      padding: 16px;
      font-size: 18px;
    }

    .container { max-width: 1000px; margin: 0 auto; }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 2px solid #dee2e6;
    }

    .header {
      text-align: center;
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 40px 32px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    h1 { font-size: 32px; margin-bottom: 16px; font-weight: bold; }
    h2 { font-size: 24px; margin-bottom: 20px; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 8px; font-weight: bold; }
    h3 { font-size: 20px; margin-bottom: 16px; color: #34495e; font-weight: bold; }

    .btn {
      display: inline-block;
      padding: 16px 32px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-size: 18px;
      font-weight: bold;
      margin: 8px;
      transition: all 0.2s ease;
      font-family: inherit;
      min-height: 60px;
      min-width: 120px;
    }

    .btn:hover:not(:disabled) { background: #2980b9; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn-success { background: #27ae60; }
    .btn-success:hover:not(:disabled) { background: #219a52; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover:not(:disabled) { background: #c0392b; }
    .btn-warning { background: #f39c12; color: #212529; }
    .btn-warning:hover:not(:disabled) { background: #e67e22; }
    .btn-secondary { background: #95a5a6; }
    .btn-secondary:hover:not(:disabled) { background: #7f8c8d; }
    .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }

    input, select, textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 18px;
      margin: 8px 0;
      font-family: inherit;
      background: #ffffff;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #2c3e50;
      font-size: 18px;
    }

    .connection-status {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      margin: 8px 0;
    }

    .connection-online {
      background: #d5f4e6;
      color: #27ae60;
      border: 2px solid #27ae60;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 3px solid #3498db;
      border-radius: 12px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-color: #2980b9; }

    .stat-value {
      font-size: 48px;
      font-weight: bold;
      color: #e74c3c;
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      font-size: 16px;
      color: #2c3e50;
      font-weight: bold;
    }

    .tab-nav {
      display: flex;
      background: #ecf0f1;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      border: 2px solid #bdc3c7;
    }

    .tab-btn {
      flex: 1;
      padding: 16px 20px;
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
    }

    .tab-btn.active { background: #3498db; color: white; }
    .tab-btn:hover:not(.active) { background: #d5dbdb; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .form-group { margin-bottom: 20px; }

    .form-hint {
      color: #666;
      font-size: 14px;
      margin-top: 4px;
    }

    .message {
      padding: 20px 24px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 6px solid;
      font-size: 16px;
      font-weight: bold;
    }

    .success-message { background: #d5f4e6; color: #27ae60; border-color: #27ae60; }
    .error-message { background: #fadbd8; color: #e74c3c; border-color: #e74c3c; }
    .info-message { background: #d6eaf8; color: #3498db; border-color: #3498db; }

    .new-meeting-section {
      background: linear-gradient(135deg, #e8f5e8, #d5f4e6);
      padding: 40px 32px;
      border-radius: 12px;
      text-align: center;
      margin: 24px 0;
      border: 3px solid #27ae60;
    }

    .new-meeting-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #27ae60;
    }

    .event-id-display {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      font-family: "Courier New", monospace;
      margin: 20px 0;
      border: 2px solid #dee2e6;
      word-break: break-all;
      font-size: 14px;
      font-weight: bold;
    }

    .recent-attendees {
      max-height: 600px;
      overflow-y: auto;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .attendee-item {
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
      background: white;
      margin: 4px;
      border-radius: 8px;
      border-left: 6px solid #3498db;
    }

    .attendee-name {
      font-weight: bold;
      color: #2c3e50;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .attendee-info {
      font-size: 16px;
      color: #495057;
      line-height: 1.6;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #dee2e6;
      align-items: center;
    }

    .status-label {
      font-weight: bold;
      color: #2c3e50;
      font-size: 18px;
    }

    .status-value {
      color: #3498db;
      font-family: "Courier New", monospace;
      background: #f8f9fa;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      border: 1px solid #dee2e6;
    }

    .notice {
      background: #fff3cd;
      color: #856404;
      padding: 20px 24px;
      border-radius: 8px;
      border: 2px solid #ffeaa7;
      margin-bottom: 24px;
      font-size: 16px;
      font-weight: bold;
    }

    .settings-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid #dee2e6;
    }

    .settings-section:last-child { border-bottom: none; }

    .spinner {
      border: 6px solid #ecf0f1;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 20px;
      font-weight: bold;
      color: #34495e;
    }

    .hidden { display: none; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      body { padding: 12px; font-size: 20px; }
      .card { padding: 24px; }
      .stats-grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .btn { width: 100%; margin: 8px 0; padding: 20px 16px; font-size: 20px; }
      h1 { font-size: 28px; }
      .tab-btn { padding: 12px 8px; font-size: 14px; }
    }

    .btn:focus, input:focus, select:focus, textarea:focus {
      outline: 3px solid #f39c12;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div id="loginSection" class="card">
      <div class="header">
        <h1>ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜ ê´€ë¦¬</h1>
        <p class="header-desc">ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
        <div id="connectionStatus" class="connection-status connection-online">ì‹œìŠ¤í…œ ì¤€ë¹„ë¨</div>
      </div>

      <div class="form-group">
        <label for="adminPassword">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
               onkeypress="if(event.keyCode===13) login()">
      </div>

      <button class="btn btn-success" onclick="login()" id="loginBtn">
        ë¡œê·¸ì¸
      </button>

      <div id="loginMessage"></div>

      <div class="notice">
        <strong>ì•ˆë‚´ì‚¬í•­:</strong><br><br>
        ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: <strong>yongin2024</strong><br>
        ë³´ì•ˆ ì„¤ì •ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥<br><br>
        ì²˜ìŒ ì‚¬ìš©í•˜ì‹œëŠ” ê²½ìš° ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”
      </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div id="adminDashboard" class="hidden">
      <!-- í—¤ë” -->
      <div class="card">
        <div class="header">
          <h1>ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜ ê´€ë¦¬</h1>
          <p id="lastUpdated" class="header-desc">ì‹œìŠ¤í…œ ë¡œë”©ì¤‘...</p>
          <div id="connectionStatusDashboard" class="connection-status connection-online">ì˜¨ë¼ì¸</div>
          <div class="header-buttons">
            <button class="btn btn-success" onclick="refreshAll()">ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-warning" onclick="openSpreadsheet()">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</button>
            <button class="btn btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì¶œì„ í˜„í™© -->
      <div class="card">
        <h2>ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©</h2>

        <div class="stats-grid">
          <div class="stat-card" onclick="refreshStats()">
            <div class="stat-value" id="totalAttendees">-</div>
            <div class="stat-label">ì´ ì¶œì„ì</div>
          </div>
          <div class="stat-card" onclick="refreshStats()">
            <div class="stat-value" id="currentEventAttendees">-</div>
            <div class="stat-label">í˜„ì¬ íšŒì˜ ì¶œì„ì</div>
          </div>
          <div class="stat-card" onclick="refreshStats()">
            <div class="stat-value" id="deviceBlocked">-</div>
            <div class="stat-label">ê¸°ê¸° ì°¨ë‹¨</div>
          </div>
          <div class="stat-card" onclick="refreshStats()">
            <div class="stat-value" id="emailsSent">-</div>
            <div class="stat-label">ì´ë©”ì¼ ë°œì†¡</div>
          </div>
        </div>

        <!-- ìƒˆ íšŒì˜ ì‹œì‘ -->
        <div class="new-meeting-section">
          <div class="new-meeting-title">ìƒˆ íšŒì˜ ì‹œì‘í•˜ê¸°</div>
          <p class="new-meeting-desc">
            ìƒˆ íšŒì˜ë¥¼ ì‹œì‘í•˜ë©´ ëª¨ë“  ê¸°ê¸°ì—ì„œ ë‹¤ì‹œ ì¶œì„ ì²´í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </p>
          <div class="event-id-display">
            <strong>í˜„ì¬ ì´ë²¤íŠ¸ ID:</strong><br>
            <span id="currentEventId">ë¡œë”© ì¤‘...</span>
          </div>
          <input type="text" id="newMeetingTitle" placeholder="ìƒˆ íšŒì˜ ì œëª© (ì„ íƒì‚¬í•­)" class="meeting-title-input">
          <button class="btn btn-success" onclick="startNewMeeting()" id="newMeetingBtn">
            ìƒˆ íšŒì˜ ì‹œì‘í•˜ê¸°
          </button>
        </div>

        <!-- ì¶œì„ì ëª©ë¡ -->
        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchTab('recent')">ìµœê·¼ ì¶œì„ì</button>
          <button class="tab-btn" onclick="switchTab('blocked')">ì°¨ë‹¨ ê¸°ë¡</button>
        </div>

        <div id="tab-recent" class="tab-content active">
          <h3>ìµœê·¼ ì¶œì„ì í˜„í™© (í˜„ì¬ íšŒì˜)</h3>
          <div class="recent-attendees" id="recentAttendees">
            <div class="loading-container">
              <div class="spinner"></div>
              <div class="loading-text">ì¶œì„ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
          </div>
        </div>

        <div id="tab-blocked" class="tab-content">
          <h3>ê¸°ê¸° ì°¨ë‹¨ ê¸°ë¡</h3>
          <div class="recent-attendees" id="blockedDevices">
            <div class="loading-container">
              <div class="spinner"></div>
              <div class="loading-text">ì°¨ë‹¨ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
      <div class="card">
        <h2>ì‹œìŠ¤í…œ ì„¤ì •</h2>

        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchSettingsTab('location')">ìœ„ì¹˜ ì„¤ì •</button>
          <button class="tab-btn" onclick="switchSettingsTab('meeting')">íšŒì˜ ì„¤ì •</button>
          <button class="tab-btn" onclick="switchSettingsTab('security')">ë³´ì•ˆ ì„¤ì •</button>
        </div>

        <!-- ìœ„ì¹˜ ì„¤ì • -->
        <div id="settings-tab-location" class="tab-content active">
          <div class="settings-section">
            <div class="form-grid">
              <div class="form-group">
                <label for="targetLatitude">íšŒì˜ì‹¤ ìœ„ë„</label>
                <input type="number" id="targetLatitude" step="0.000001" placeholder="37.2420">
                <p class="form-hint">ì˜ˆ: 37.2420 (ìš©ì¸ëŒ€í•™êµ ë³¸ê´€)</p>
              </div>

              <div class="form-group">
                <label for="targetLongitude">íšŒì˜ì‹¤ ê²½ë„</label>
                <input type="number" id="targetLongitude" step="0.000001" placeholder="127.1775">
                <p class="form-hint">ì˜ˆ: 127.1775 (ìš©ì¸ëŒ€í•™êµ ë³¸ê´€)</p>
              </div>

              <div class="form-group">
                <label for="locationRadius">í—ˆìš© ë°˜ê²½ (ë¯¸í„°)</label>
                <input type="number" id="locationRadius" min="100" max="5000" placeholder="1200">
                <p class="form-hint">ê¶Œì¥: ì‹¤ë‚´ 1200m, ì‹¤ì™¸ 500m</p>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-secondary" onclick="getCurrentLocation()">
                í˜„ì¬ ìœ„ì¹˜ë¡œ ì„¤ì •
              </button>
              <button class="btn btn-success" onclick="saveLocationSettings()">
                ìœ„ì¹˜ ì„¤ì • ì €ì¥
              </button>
            </div>
          </div>
        </div>

        <!-- íšŒì˜ ì„¤ì • -->
        <div id="settings-tab-meeting" class="tab-content">
          <div class="settings-section">
            <div class="form-group">
              <label for="meetingTitle">íšŒì˜ ì œëª©</label>
              <input type="text" id="meetingTitle" placeholder="ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜">
            </div>

            <div class="form-group">
              <label for="meetingDescription">íšŒì˜ ì„¤ëª…</label>
              <textarea id="meetingDescription" rows="4" placeholder="ì¶œì„ ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
            </div>

            <button class="btn btn-success" onclick="saveMeetingSettings()">íšŒì˜ ì„¤ì • ì €ì¥</button>
          </div>
        </div>

        <!-- ë³´ì•ˆ ì„¤ì • -->
        <div id="settings-tab-security" class="tab-content">
          <div class="settings-section">
            <div class="form-group">
              <label for="newAdminPassword">ìƒˆ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="newAdminPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
            </div>

            <div class="form-group">
              <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
              <label for="notificationEmail">ì•Œë¦¼ ì´ë©”ì¼</label>
              <input type="email" id="notificationEmail" placeholder="admin@example.com">
            </div>

            <button class="btn btn-success" onclick="saveSecuritySettings()">ë³´ì•ˆ ì„¤ì • ì €ì¥</button>
            <button class="btn btn-warning" onclick="testEmailSystem()">ì´ë©”ì¼ í…ŒìŠ¤íŠ¸</button>
          </div>
        </div>

        <div id="settingsMessage"></div>
      </div>

      <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
      <div class="card">
        <h2>ì‹œìŠ¤í…œ ìƒíƒœ</h2>
        <div id="systemStatus">
          <div class="status-item">
            <div class="status-label">ì‹œìŠ¤í…œ ìƒíƒœ</div>
            <span class="status-value" id="systemStatusValue">ì •ìƒ</span>
          </div>
          <div class="status-item">
            <div class="status-label">ì„¤ì •ëœ ìœ„ì¹˜</div>
            <span class="status-value" id="currentLocation">-</span>
          </div>
          <div class="status-item">
            <div class="status-label">í—ˆìš© ë°˜ê²½</div>
            <span class="status-value" id="currentRadius">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var isLoggedIn = false;
    var refreshInterval = null;

    window.addEventListener('load', function() {
      document.getElementById('adminPassword').focus();
    });

    function login() {
      var password = document.getElementById('adminPassword').value.trim();
      var messageDiv = document.getElementById('loginMessage');

      if (!password) {
        showMessage('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', messageDiv);
        return;
      }

      showMessage('ë¡œê·¸ì¸ ì¤‘...', 'info', messageDiv);

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result === true) {
              loginSuccess(messageDiv);
            } else {
              loginFailure(messageDiv);
            }
          })
          .withFailureHandler(function(error) {
            tryFallbackLogin(password, messageDiv);
          })
          .authenticateAdmin(password);
      } else {
        tryFallbackLogin(password, messageDiv);
      }
    }

    function tryFallbackLogin(password, messageDiv) {
      if (password === 'yongin2024') {
        loginSuccess(messageDiv, true);
      } else {
        showMessage('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤. ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: yongin2024', 'error', messageDiv);
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      }
    }

    function loginSuccess(messageDiv, isOffline) {
      isLoggedIn = true;
      var message = isOffline ? 'ë¡œê·¸ì¸ ì„±ê³µ! (ê¸°ë³¸ ëª¨ë“œ)' : 'ë¡œê·¸ì¸ ì„±ê³µ!';
      showMessage(message, 'success', messageDiv);

      setTimeout(function() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        initializeDashboard();
      }, 1500);
    }

    function loginFailure(messageDiv) {
      showMessage('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error', messageDiv);
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }

    function initializeDashboard() {
      updateLastUpdated();
      loadCurrentSettings();
      refreshAll();

      refreshInterval = setInterval(function() {
        if (isLoggedIn) {
          refreshStats();
          updateLastUpdated();
        }
      }, 180000);
    }

    function updateLastUpdated() {
      var now = new Date();
      document.getElementById('lastUpdated').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + now.toLocaleString();
    }

    function refreshAll() {
      if (!isLoggedIn) return;
      refreshStats();
      refreshSystemStatus();
      updateLastUpdated();
    }

    function refreshStats() {
      if (!isLoggedIn) return;

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success && result.stats) {
              updateStatsDisplay(result.stats);
              updateRecentAttendees(result.stats.recentAttendees || []);
              updateBlockedDevices(result.stats.blockedDevices || []);
            } else {
              setDefaultStats();
            }
          })
          .withFailureHandler(function(error) {
            setDefaultStats();
          })
          .getAttendanceStats();
      } catch (error) {
        setDefaultStats();
      }
    }

    function refreshSystemStatus() {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              document.getElementById('currentEventId').textContent = result.currentEventId || 'N/A';
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('currentEventId').textContent = 'N/A';
          })
          .getSystemStatus();
      } catch (error) {
        document.getElementById('currentEventId').textContent = 'N/A';
      }
    }

    function updateStatsDisplay(stats) {
      document.getElementById('totalAttendees').textContent = stats.totalAttendees || 0;
      document.getElementById('currentEventAttendees').textContent = stats.currentEventAttendees || 0;
      document.getElementById('deviceBlocked').textContent = stats.deviceBlocked || 0;
      document.getElementById('emailsSent').textContent = stats.emailsSent || 0;
    }

    function setDefaultStats() {
      document.getElementById('totalAttendees').textContent = '-';
      document.getElementById('currentEventAttendees').textContent = '-';
      document.getElementById('deviceBlocked').textContent = '-';
      document.getElementById('emailsSent').textContent = '-';

      document.getElementById('recentAttendees').innerHTML =
        '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>ì¶œì„ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';

      document.getElementById('blockedDevices').innerHTML =
        '<div class="empty-state"><div class="empty-icon">ğŸš«</div><div>ì°¨ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
    }

    function updateRecentAttendees(attendees) {
      var container = document.getElementById('recentAttendees');

      if (!attendees || attendees.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>ì•„ì§ ì¶œì„ìê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }

      var html = '';
      for (var i = 0; i < attendees.length; i++) {
        var attendee = attendees[i];
        html += '<div class="attendee-item">';
        html += '<div class="attendee-name">' + (i + 1) + '. ' + (attendee.name || 'ì´ë¦„ ì—†ìŒ') + '</div>';
        html += '<div class="attendee-info">';
        html += 'ì†Œì†: ' + (attendee.department || 'ì†Œì† ì—†ìŒ') + '<br>';
        html += 'ì´ë©”ì¼: ' + (attendee.email || '(ë¯¸ì…ë ¥)') + '<br>';
        html += 'ì‹œê°„: ' + (attendee.time || 'ì‹œê°„ ì •ë³´ ì—†ìŒ') + '<br>';
        html += 'ê±°ë¦¬: ' + (attendee.distance || 'N/A') + 'm';
        html += '</div></div>';
      }

      container.innerHTML = html;
    }

    function updateBlockedDevices(blockedDevices) {
      var container = document.getElementById('blockedDevices');

      if (!blockedDevices || blockedDevices.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸš«</div><div>ì°¨ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }

      var html = '';
      for (var i = 0; i < blockedDevices.length; i++) {
        var blocked = blockedDevices[i];
        html += '<div class="attendee-item blocked">';
        html += '<div class="attendee-name blocked-name">' + (i + 1) + '. ' + (blocked.name || 'ì´ë¦„ ì—†ìŒ') + ' (ì°¨ë‹¨ë¨)</div>';
        html += '<div class="attendee-info">';
        html += 'ì†Œì†: ' + (blocked.department || 'ì†Œì† ì—†ìŒ') + '<br>';
        html += 'ì‹œê°„: ' + (blocked.time || 'ì‹œê°„ ì •ë³´ ì—†ìŒ') + '<br>';
        html += 'ì‚¬ìœ : ' + (blocked.reason || 'N/A');
        html += '</div></div>';
      }

      container.innerHTML = html;
    }

    function startNewMeeting() {
      var title = document.getElementById('newMeetingTitle').value.trim();

      if (!confirm('ìƒˆ íšŒì˜ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ê¸°ê¸°ì—ì„œ ë‹¤ì‹œ ì¶œì„ ì²´í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.')) {
        return;
      }

      var button = document.getElementById('newMeetingBtn');
      var originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤...';

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            button.disabled = false;
            button.textContent = originalText;

            if (result && result.success) {
              alert('ìƒˆ íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ë²¤íŠ¸ ID: ' + (result.eventId || 'ìƒì„±ë¨'));
              document.getElementById('currentEventId').textContent = result.eventId || 'ìƒì„±ë¨';
              document.getElementById('newMeetingTitle').value = '';
              setTimeout(refreshAll, 2000);
            } else {
              alert('ìƒˆ íšŒì˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (result.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          })
          .withFailureHandler(function(error) {
            button.disabled = false;
            button.textContent = originalText;
            alert('ìƒˆ íšŒì˜ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
          })
          .startNewMeetingFixed(title);
      } catch (error) {
        button.disabled = false;
        button.textContent = originalText;
        alert('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
      }
    }

    function loadCurrentSettings() {
      try {
        google.script.run
          .withSuccessHandler(function(settings) {
            updateSettingsUI(settings);
          })
          .withFailureHandler(function(error) {
            updateSettingsUI({});
          })
          .getSettings();
      } catch (error) {
        updateSettingsUI({});
      }
    }

    function updateSettingsUI(settings) {
      settings = settings || {};

      document.getElementById('targetLatitude').value = settings.target_latitude || '37.2420';
      document.getElementById('targetLongitude').value = settings.target_longitude || '127.1775';
      document.getElementById('locationRadius').value = settings.location_radius || '1200';
      document.getElementById('meetingTitle').value = settings.meeting_title || 'ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜';
      document.getElementById('meetingDescription').value = settings.meeting_description || 'ì¶œì„ ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”';
      document.getElementById('notificationEmail').value = settings.notification_email || '';

      document.getElementById('currentLocation').textContent = (settings.target_latitude || '37.2420') + ', ' + (settings.target_longitude || '127.1775');
      document.getElementById('currentRadius').textContent = (settings.location_radius || '1200') + 'm';
    }

    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showSettingsMessage('ìœ„ì¹˜ ì„œë¹„ìŠ¤ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      showSettingsMessage('í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...', 'info');

      navigator.geolocation.getCurrentPosition(
        function(position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var accuracy = position.coords.accuracy;

          document.getElementById('targetLatitude').value = lat.toFixed(6);
          document.getElementById('targetLongitude').value = lng.toFixed(6);

          var recommendedRadius = 1200;
          if (accuracy > 500) {
            recommendedRadius = 2000;
          } else if (accuracy > 200) {
            recommendedRadius = 1500;
          } else if (accuracy > 100) {
            recommendedRadius = 1000;
          }

          document.getElementById('locationRadius').value = recommendedRadius;

          showSettingsMessage('í˜„ì¬ ìœ„ì¹˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nìœ„ë„: ' + lat.toFixed(6) + '\nê²½ë„: ' + lng.toFixed(6) + '\nGPS ì •í™•ë„: ' + Math.round(accuracy) + 'm\nê¶Œì¥ ë°˜ê²½: ' + recommendedRadius + 'm', 'success');
        },
        function(error) {
          var errorMessage = 'ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°½ê°€ë¡œ ì´ë™í•˜ê±°ë‚˜ WiFië¥¼ ì—°ê²°í•´ë³´ì„¸ìš”.';
              break;
            case error.TIMEOUT:
              errorMessage = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.';
              break;
          }

          showSettingsMessage(errorMessage, 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 60000
        }
      );
    }

    function saveLocationSettings() {
      var settings = {
        target_latitude: document.getElementById('targetLatitude').value,
        target_longitude: document.getElementById('targetLongitude').value,
        location_radius: document.getElementById('locationRadius').value
      };
      saveSettings(settings);
    }

    function saveMeetingSettings() {
      var settings = {
        meeting_title: document.getElementById('meetingTitle').value,
        meeting_description: document.getElementById('meetingDescription').value
      };
      saveSettings(settings);
    }

    function saveSecuritySettings() {
      var newPassword = document.getElementById('newAdminPassword').value;
      var confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword && newPassword !== confirmPassword) {
        showSettingsMessage('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      if (newPassword && newPassword.length < 6) {
        showSettingsMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
        return;
      }

      var settings = {
        notification_email: document.getElementById('notificationEmail').value
      };

      if (newPassword) {
        settings.admin_password = newPassword;
      }

      saveSettings(settings);
    }

    function saveSettings(newSettings) {
      showSettingsMessage('ì„¤ì • ì €ì¥ ì¤‘...', 'info');

      try {
        google.script.run
          .withSuccessHandler(function(currentSettings) {
            var updatedSettings = Object.assign({}, currentSettings, newSettings);

            google.script.run
              .withSuccessHandler(function(result) {
                if (result && result.success) {
                  showSettingsMessage('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                  updateSettingsUI(updatedSettings);
                  setTimeout(refreshAll, 1000);
                } else {
                  showSettingsMessage('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
              })
              .withFailureHandler(function(error) {
                showSettingsMessage('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
              })
              .saveSettings(updatedSettings);
          })
          .withFailureHandler(function(error) {
            showSettingsMessage('ì„¤ì • ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          })
          .getSettings();
      } catch (error) {
        showSettingsMessage('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    function testEmailSystem() {
      showSettingsMessage('ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ë°œì†¡ ì¤‘...', 'info');

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              showSettingsMessage('í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
              showSettingsMessage(result.error || 'ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
          })
          .withFailureHandler(function(error) {
            showSettingsMessage('ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
          })
          .testEmailSystem();
      } catch (error) {
        showSettingsMessage('ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        isLoggedIn = false;

        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }

        document.getElementById('adminDashboard').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('adminPassword').value = '';
        document.getElementById('loginMessage').innerHTML = '';

        setTimeout(function() {
          document.getElementById('adminPassword').focus();
        }, 300);
      }
    }

    function switchTab(tabName) {
      var tabs = document.querySelectorAll('[id^="tab-"]');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }

      var buttons = document.querySelectorAll('.tab-nav .tab-btn');
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i].onclick && buttons[i].onclick.toString().indexOf('switchSettingsTab') === -1) {
          buttons[i].classList.remove('active');
        }
      }

      if (event && event.target) {
        event.target.classList.add('active');
      }

      var activeTab = document.getElementById('tab-' + tabName);
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    function switchSettingsTab(tabName) {
      var tabs = document.querySelectorAll('[id^="settings-tab-"]');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }

      var buttons = document.querySelectorAll('.tab-nav .tab-btn');
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i].onclick && buttons[i].onclick.toString().indexOf('switchSettingsTab') > -1) {
          buttons[i].classList.remove('active');
        }
      }

      if (event && event.target) {
        event.target.classList.add('active');
      }

      var activeTab = document.getElementById('settings-tab-' + tabName);
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    function showMessage(message, type, container) {
      var className = 'info-message';
      if (type === 'success') className = 'success-message';
      else if (type === 'error') className = 'error-message';

      container.innerHTML = '<div class="message ' + className + '">' + message.replace(/\n/g, '<br>') + '</div>';

      if (type === 'success') {
        setTimeout(function() {
          container.innerHTML = '';
        }, 4000);
      }
    }

    function showSettingsMessage(message, type) {
      var container = document.getElementById('settingsMessage');
      showMessage(message, type, container);
    }

    function openSpreadsheet() {
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.spreadsheetUrl) {
              window.open(result.spreadsheetUrl, '_blank');
            } else {
              alert('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            alert('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          })
          .getSystemStatus();
      } catch (error) {
        alert('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    window.addEventListener('beforeunload', function() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>

  <style>
    .header-desc { font-size: 18px; margin-top: 12px; }
    .header-buttons { margin-top: 20px; }
    .new-meeting-desc { margin-bottom: 20px; font-size: 18px; font-weight: bold; }
    .meeting-title-input { max-width: 500px; margin: 16px auto; display: block; font-size: 18px; }
    .loading-container { text-align: center; padding: 60px; }
    .empty-state { text-align: center; padding: 60px; font-size: 20px; color: #666; }
    .empty-icon { font-size: 48px; margin-bottom: 20px; }
    .attendee-item.blocked { border-left-color: #e74c3c; }
    .blocked-name { color: #e74c3c; }
    .button-group { margin-top: 20px; }
  </style>
</body>
</html>
